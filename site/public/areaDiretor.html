<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>DATAWATCH | Administração</title>

    <script src="./js/funcoes.js"></script>

    <link rel="icon" href="./assets/imgs/LOGOV2.png">
    <link rel="stylesheet" href="./css/areaDiretor.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

</head>

<body onload="getUuid()">
    <!-- NAVBAR -->
    <header>
        <nav class="nav-bar">
            <div class="hamburger-menu">
                <input id="menu__toggle" type="checkbox" />
                <label class="menu__btn" for="menu__toggle">
                    <span></span>
                </label>



                <ul class="menu__box">
                    <div class="image">
                        <img src="./assets/imgs/imagem-do-usuario-com-fundo-preto.png" alt=""
                            style="height: 200px; width: 200px; border-radius: 50%; ">
                    </div>
                    <div class="nomeUser">
                        <span id="nome_usuario_menu"></span>
                    </div>
                    <li><a class="menu__item" href="../public/areaFuncionário.html">Home</a></li>
                    <li id="lateral_menu_cad_download"><a class="menu__item" href="./JAR/DATAWATCH-sistema.zip"
                            download="app_DataWatch">Baixar aplicativo</a></li>
                    <li><a class="menu__item" onclick="limparSessao()">Logout</a></li>
                </ul>
            </div>



            <div class="logo"><button class="notify" onmouseover="configIn()" onmouseout="configOut()">
                    <img src="./assets/imgs/conf-hover.png" id="conf_normal" width="35px">
                        <img src="./assets/imgs/conf-normal.png" id="conf_yellow" width="35px" style="display: none;"></button>
                <a href="./areaFuncionário.html">
                    <img src="assets/imgs/LOGOcomTextoV2.png" alt="" width="150px">
                </a>
            </div>
        </nav>

    </header>

    <section>
        <div class="usuario">
            <span id="span_usuario"></span>
        </div>
        <div class="container">
            <div class="placa">
                <div class="legenda">
                    <span class="legendaTexto">
                        <div class="corLegenda"></div>
                        <p>estável</p>
                    </span>
                    <span class="legendaTexto">
                        <div class="corLegenda2"></div>
                        <p>atenção</p>
                    </span>
                    <span class="legendaTexto">
                        <div class="corLegenda3"></div>
                        <p>urgente</p>
                    </span>
                </div>


                <ul class="cards" id="ul_cards_filiais">
                    <li class="card">
                        <h3 id="cardTitle">Filial Bela Cintra</h3>
                        <div class="cubeLikeUp">
                            <div class="filialAdress">
                                <div class="icon"></div>
                                <b>R. Bela Cintra, 1173 - Consolação, São Paulo - SP</b>
                            </div>
                            <div class="filialInfo">
                                <b>Máquinas ativas:</b>
                                <b class="largeFont" id="cent">0.0%</b>
                            </div>
                        </div>
                        <div class="cubeLikeDown">
                            <div class="responsavelInfo">
                                <b>Responsável</b>
                                <p>Victor Daniel</p>
                                <p>victor@gmail.com</p>
                            </div>
                            <div class="alertaPeso">
                                <b>Alertas nos últimos 30 dias</b>
                                <div class="alerts">
                                    <b class="largeFont">5</b>
                                    <div class="alert">
                                        <img src="./assets/imgs/aviso.png" width="50px">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </section>
</body>
<script>
    nome_usuario_menu.innerHTML = `${sessionStorage.NOME_USUARIO}`

    function configIn() {
        conf_normal.style.display = 'none';
        conf_yellow.style.display = 'flex';
    }

    function configOut() {
        conf_yellow.style.display = 'none';
        conf_normal.style.display = 'flex ';
    }

    function getUuid() {
        var uuid = sessionStorage.UUID;
        var usuario = sessionStorage.NOME_USUARIO;
        if (usuario == '') {
            span_usuario.innerHTML = `Olá, visitante!`
        } else {
            span_usuario.innerHTML = `Olá, ${usuario}!`
        }

        mostrarFiliais(uuid)
    }

    function mostrarFiliais(uuid) {
        fetch("/datawatch/pegarFiliais", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                uuidServer: uuid
            })
        }).then(function (resposta) {
            if (resposta.ok) {

                resposta.json().then(dados => {
                    console.log(dados);
                    if (dados.length > 0) {
                        dados.forEach(filial => {
                            // Pega o id da tag ul e atribui a uma variável
                            var listaFiliais = document.getElementById("ul_cards_filiais");

                            /* Criação do card */
                            var li = document.createElement("li")
                            li.setAttribute("class", "card")
                            listaFiliais.appendChild(li);

                            var titleFilial = document.createElement("h3");
                            li.appendChild(titleFilial);
                            titleFilial.innerHTML = `${filial.razaoSocial}`;

                            var upSide = document.createElement("div");
                            upSide.setAttribute("class", "cubeLikeUp");
                            li.appendChild(upSide);

                            /* PARTE DE CIMA DO CARD */
                            /* ------ ESQUERDA: ---------- */
                            var adressInfo = document.createElement("div");
                            adressInfo.setAttribute("class", "localInfo");
                            upSide.appendChild(adressInfo);

                            var divIcon = document.createElement("div")
                            divIcon.setAttribute("class", "icon")
                            adressInfo.appendChild(divIcon);

                            var adress = document.createElement("p");
                            adressInfo.appendChild(adress);
                            adress.innerHTML = `<b>Responsável</b> ${filial.administrador} ${filial.email}`
                            /*  adress.innerHTML = `${filial.logradouro}, ${filial.numero} - ${filial.bairro}, ${filial.cidade} - ${filial.estado}`;
                             */ /* ----------------------- */

                            /* ------ DIREITA: ------ */
                            var divFilial = document.createElement("div")
                            divFilial.setAttribute("class", "maquinaInfo")
                            upSide.appendChild(divFilial);

                            var titlePerct = document.createElement("b");
                            divFilial.appendChild(titlePerct);
                            titlePerct.innerHTML = `Máquinas ativas:`;

                            var maqPerct = document.createElement("b");
                            maqPerct.setAttribute("class", "largeFont");
                            divFilial.appendChild(maqPerct);
                            var maqAtiv = filial.maquinasAtivas;
                            var maqQtd = filial.qtdMaquinas;
                            var porcentagem = (maqAtiv / maqQtd) * 100;
                            maqPerct.innerHTML = `${porcentagem.toFixed(1)}%`;

                            if (porcentagem < 50) {
                                li.style = "background-color: rgb(255, 179, 179)"
                            } else if (porcentagem < 75) {
                                li.style = "background-color: rgb(255, 254, 167)"
                            } else {
                                li.style = "background-color: rgb(189, 255, 188)"
                            }
                            /* ----------------------- */

                            /* PARTE DE BAIXO DO CARD */
                            var downSide = document.createElement("div");
                            downSide.setAttribute("class", "cubeLikeDown");
                            li.appendChild(downSide);

                            /* ------ ESQUERDA: ------ */
                            var adm = document.createElement("div");
                            adm.setAttribute("class", "responsavelInfo");
                            downSide.appendChild(adm);

                            var tituloAdm = document.createElement("b");
                            adm.appendChild(tituloAdm);
                            tituloAdm.innerHTML = `${filial.logradouro}, ${filial.numero} - ${filial.bairro}, ${filial.cidade} - ${filial.estado}`;
                            /* ----------------------- */

                            /* ------ DIREITA: ------ */
                            var alertas = document.createElement("div");
                            alertas.setAttribute("class", "alertaPeso");
                            downSide.appendChild(alertas);

                            var alertTitle = document.createElement("b");
                            alertas.appendChild(alertTitle);
                            alertTitle.innerHTML = `Peso total dos alertas`;

                            var auxDiv = document.createElement("div");
                            auxDiv.setAttribute("class", "alerts");
                            alertas.appendChild(auxDiv);

                            var qtdAlerts = document.createElement("b");
                            qtdAlerts.setAttribute("class", "largeFont");
                            auxDiv.appendChild(qtdAlerts);
                            qtdAlerts.innerHTML = `${filial.qtdLogs}`;

                            var iconAlert = document.createElement("div");
                            iconAlert.setAttribute("class", "alert");
                            auxDiv.appendChild(iconAlert);

                            var imgAlert = document.createElement("img");
                            var buttonAlertDiv = document.createElement("div");
                            imgAlert.setAttribute("src", "./assets/imgs/aviso.png");
                            imgAlert.setAttribute("width", "50px");
                            iconAlert.appendChild(imgAlert);
                            /* ----------------------- */
                        });
                    }

                })
            }
            else {
                throw (JSON.stringify(resposta))
            }
        }).catch(function (resposta) {
            console.log(`ERRO: ${resposta}`);
        })
        return false
    }
</script>