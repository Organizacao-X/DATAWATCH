<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>DATAWATCH | Administração</title>

    <script src="./js/funcoes.js"></script>

    <link rel="icon" href="./assets/imgs/LOGOV2.png">
    <link rel="stylesheet" href="./css/areaDiretor.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

</head>

<body onload="getUuid()">
    <!-- NAVBAR -->
    <header>
        <nav class="nav-bar">
            <div class="hamburger-menu">
                <input id="menu__toggle" type="checkbox" />
                <label class="menu__btn" for="menu__toggle">
                    <span></span>
                </label>



                <ul class="menu__box">
                    <div class="image">
                        <img src="./assets/imgs/imagem-do-usuario-com-fundo-preto.png" alt=""
                            style="height: 200px; width: 200px; border-radius: 50%; ">
                    </div>
                    <div class="nomeUser">
                        <span id="nome_usuario_menu"></span>
                    </div>
                    <li><a class="menu__item" href="../public/areaFuncionário.html">Home</a></li>
                    <li id="lateral_menu_cad_download"><a class="menu__item" href="./JAR/DATAWATCH-sistema.zip"
                            download="app_DataWatch">Baixar aplicativo</a></li>
                    <li><a class="menu__item" onclick="limparSessao()">Logout</a></li>
                </ul>
            </div>



            <div class="logo">
                <button class="notify" onmouseover="configIn()" onmouseout="configOut()">
                    <img src="./assets/imgs/conf-hover.png" id="conf_normal" width="35px">
                    <img src="./assets/imgs/conf-normal.png" id="conf_yellow" width="35px"
                        style="display: none;"></button>
                <a href="./areaDiretor.html">
                    <img src="assets/imgs/LOGOcomTextoV2.png" alt="" width="150px">
                </a>
            </div>
        </nav>

    </header>

    <section>

        <div class="usuario">
            <span id="span_usuario"></span>
        </div>
        <div class="container">
            <div class="placa">
                <div class="legenda">
                    <span class="legendaTexto">
                        <div class="corLegenda"></div>
                        <p>estável</p>
                    </span>
                    <span class="legendaTexto">
                        <div class="corLegenda2"></div>
                        <p>atenção</p>
                    </span>
                    <span class="legendaTexto">
                        <div class="corLegenda3"></div>
                        <p>urgente</p>
                    </span>
                </div>


                <ul class="cards" id="ul_cards_filiais">
                    <li class="card">
                        <h3>Empresa Victor</h3>
                        <div class="cubeLikeUp">
                            <div class="admInfo">
                                <div class="icon"></div>
                                <div class="responsavelInfo">
                                    <b>Responsável</b>
                                    <p>Victor Daniel</p>
                                    <p>victor@gmail.com</p>
                                </div>
                            </div>
                            <div class="maquinaInfo">
                                <b>Máquinas ativas:</b>
                                <b class="largeFont">100.0%</b>
                            </div>
                        </div>
                        <div class="cubeLikeDown">
                            <div class="adressInfo">
                                <b>Rua Serafim Carlos, 43 - Osvaldo Cruz, Sao Caetano do Sul - SP</b>
                            </div>
                            <div class="alertaPeso">
                                <b>Peso total dos alertas</b>
                                <div class="alerts">
                                    <b class="largeFont">0</b>
                                    <div class="alert" data-tooltip="Quantidade de alertas: 50">
                                        <img src="./assets/imgs/aviso.png" width="50px">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

    </section>

    <div class="modal-parent">
        <div class="modal-alterar">
            <div class="alerta">
                <div class="texto-alerta">
                    <p>Parametrize os alertas em suas filiais:</p>
                    <select name="" id="selectFiliais">
                        <option value="">Bela Cintra</option>
                        <option value="">Consolação</option>
                        <option value="">Av. Paulista</option>
                        <option value="">Augusta</option>
                    </select>
                </div>
            </div>
            <span class="X">&times;</span>
        </div>
    </div>
</body>
<script>
    let $ = document;

    const sessaoElem = $.querySelector('section');
    const modalAviso = $.querySelector('.modal-parent');
    const buttonConfig = $.querySelector('.notify');
    const x = $.querySelector(".X");

    function abrirModalAlteracaoDiretor() {
        modalAviso.style.display = 'block';
        sessaoElem.style.filter = 'blur(10px)'
        buttonConfig.blur();
        carregarFiliais();
    }

    function fecharModalAlteracaoDiretorComX() {
        modalAviso.style.display = 'none'
        sessaoElem.style.filter = 'blur(0px)'
    }

    function fecharModalAlteracaoDiretorComEsc(event) {
        if (event.keyCode === 27) {
            modalAviso.style.display = 'none'
            sessaoElem.style.filter = 'blur(0px)'
        }
    }

    buttonConfig.addEventListener('click', abrirModalAlteracaoDiretor)
    x.addEventListener('click', fecharModalAlteracaoDiretorComX)
    document.body.addEventListener('keyup', fecharModalAlteracaoDiretorComEsc)

    nome_usuario_menu.innerHTML = `${sessionStorage.NOME_USUARIO}`

    function carregarFiliais() {
        var slct = $.getElementById("selectFiliais");
        var dados = JSON.parse(localStorage.getItem("dadosFiliais"));

        dados.forEach(filial => {
            var option = $.createElement("option");
            option.innerHTML = `${filial.razaoSocial}`;
            slct.appendChild(option);
        });
    }

    function configIn() {
        conf_normal.style.display = 'none';
        conf_yellow.style.display = 'flex';
    }

    function configOut() {
        conf_yellow.style.display = 'none';
        conf_normal.style.display = 'flex ';
    }

    function getUuid() {
        var uuid = sessionStorage.UUID;
        var usuario = sessionStorage.NOME_USUARIO;
        if (usuario == undefined) {
            span_usuario.innerHTML = `Olá, visitante!`
        } else {
            span_usuario.innerHTML = `Olá, ${usuario}!`
        }

        mostrarFiliais(uuid)
    }

    function mostrarFiliais(uuid) {
        fetch("/datawatch/pegarFiliais", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                uuidServer: uuid
            })
        }).then(function (resposta) {
            if (resposta.ok) {

                resposta.json().then(dados => {
                    console.log(dados);
                    localStorage.setItem("dadosFiliais", JSON.stringify(dados));
                    if (dados.length > 0) {
                        dados.forEach(filial => {
                            // Pega o id da tag ul e atribui a uma variável
                            var listaFiliais = $.getElementById("ul_cards_filiais");

                            /* Criação do card */
                            var li = $.createElement("li")
                            li.setAttribute("class", "card")
                            listaFiliais.appendChild(li);

                            var titleFilial = $.createElement("h3");
                            li.appendChild(titleFilial);
                            titleFilial.innerHTML = `${filial.razaoSocial}`;

                            var upSide = $.createElement("div");
                            upSide.setAttribute("class", "cubeLikeUp");
                            li.appendChild(upSide);
                            
                            /* PARTE DE CIMA DO CARD */
                            /* ------ ESQUERDA: ---------- */
                            var adm = $.createElement("div");
                            adm.setAttribute("class", "admInfo");
                            upSide.appendChild(adm);

                            var divIcon = $.createElement("div")
                            divIcon.setAttribute("class", "icon")
                            adm.appendChild(divIcon);

                            var respInfo = $.createElement("div");
                            respInfo.setAttribute("class", "responsavelInfo");
                            adm.appendChild(respInfo);
                            respInfo.innerHTML = `<b>Responsável:</b>
                            <p>${filial.administrador}</p>
                            <p>${filial.email}</p>`
                            /* ----------------------- */

                            /* ------ DIREITA: ------ */
                            var divFilial = $.createElement("div")
                            divFilial.setAttribute("class", "maquinaInfo")
                            upSide.appendChild(divFilial);

                            var titlePerct = $.createElement("b");
                            divFilial.appendChild(titlePerct);
                            titlePerct.innerHTML = `Máquinas ativas:`;

                            var maqPerct = $.createElement("b");
                            maqPerct.setAttribute("class", "largeFont");
                            divFilial.appendChild(maqPerct);
                            var maqAtiv = filial.maquinasAtivas;
                            var maqQtd = filial.qtdMaquinas;
                            var porcentagem;

                            if (maqQtd == 0 || maqAtiv == 0) {
                                porcentagem = 0;
                            } else {
                                porcentagem = ((maqAtiv / maqQtd) * 100);
                            }

                            maqPerct.innerHTML = `${porcentagem.toFixed(1)}%`;

                            if (porcentagem < 50) {
                                li.style = "background-color: rgb(255, 179, 179)"
                            } else if (porcentagem < 75) {
                                li.style = "background-color: rgb(255, 254, 167)"
                            } else {
                                li.style = "background-color: rgb(189, 255, 188)"
                            }
                            /* ----------------------- */

                            /* PARTE DE BAIXO DO CARD */
                            var downSide = $.createElement("div");
                            downSide.setAttribute("class", "cubeLikeDown");
                            li.appendChild(downSide);

                            /* ------ ESQUERDA: ------ */
                            var adress = $.createElement("div");
                            adress.setAttribute("class", "adressInfo");
                            downSide.appendChild(adress);
                            adress.innerHTML = `<b>${filial.logradouro}, 
                                ${filial.numero} - ${filial.bairro}, 
                                ${filial.cidade} - ${filial.estado}</b>`;
                            /* ----------------------- */

                            /* ------ DIREITA: ------ */
                            var alertas = $.createElement("div");
                            alertas.setAttribute("class", "alertaPeso");
                            downSide.appendChild(alertas);

                            var alertTitle = $.createElement("b");
                            alertas.appendChild(alertTitle);
                            alertTitle.innerHTML = `Peso total dos alertas`;

                            var auxDiv = $.createElement("div");
                            auxDiv.setAttribute("class", "alerts");
                            alertas.appendChild(auxDiv);
                            
                            var qtdAlerts = $.createElement("b");
                            qtdAlerts.setAttribute("class", "largeFont");
                            auxDiv.appendChild(qtdAlerts);
                            qtdAlerts.innerHTML = `${filial.somaPeso}`;
                            
                            var iconAlert = $.createElement("div");
                            iconAlert.setAttribute("class", "alert");
                            iconAlert.setAttribute("data-tooltip", `Quantidade de alertas: ${filial.qtdLogs}`);
                            auxDiv.appendChild(iconAlert);

                            var imgAlert = $.createElement("img");
                            var buttonAlertDiv = $.createElement("div");
                            imgAlert.setAttribute("src", "./assets/imgs/aviso.png");
                            imgAlert.setAttribute("width", "50px");
                            iconAlert.appendChild(imgAlert);
                            /* ----------------------- */
                        });
                    }

                })
            }
            else {
                throw (JSON.stringify(resposta))
            }
        }).catch(function (resposta) {
            console.log(`ERRO: ${resposta}`);
        })
        return false
    }
</script>