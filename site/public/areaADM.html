<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>DATAWATCH | Administração</title>

    <script src="./js/funcoes.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <link rel="icon" href="./assets/imgs/LOGOV2.png">
    <link rel="stylesheet" href="./css/areaADM.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
</head>

<!-- <body onload="mostrarConteudo()" onload="drawChart()"> -->

<body onload="mostrarConteudo()">
    <!-- NAVBAR -->
    <header>
        <nav class="nav-bar">
            <div class="hamburger-menu">
                <input id="menu__toggle" type="checkbox" />
                <label class="menu__btn" for="menu__toggle">
                    <span></span>
                </label>



                <ul class="menu__box">
                    <div class="image">
                        <img src="../public/assets/imgs/imagem-do-usuario-com-fundo-preto.png" alt=""
                            style="height: 200px; width: 200px; border-radius: 50%; ">
                    </div>
                    <div class="nomeUser">
                        <span id="lateral_menu_adm_name"></span>
                    </div>
                    <li id="lateral_menu_cad_empresa" style="display: none;"><a class="menu__item"
                            href="./cadastroEmpresa.html">Cadastrar
                            empresa</a></li>
                    <li><a class="menu__item" href="./areaADM.html">Home</a></li>
                    <li id="lateral_menu_cad_maquina"><a class="menu__item" href="./cadastromaquina.html">Cadastrar
                            maquina</a></li>
                    <li id="lateral_menu_cad_funcionario"><a class="menu__item"
                            href="./cadastroFuncionario.html">Cadastrar funcionário</a></li>
                    <li id="lateral_menu_cad_download"><a class="menu__item" href="../public/assets/icon/lapis.png"
                            download="DataWatch_app">Baixar aplicativo</a></li>
                    <li><a class="menu__item" href="#" onclick="limparSessao()">Logout</a></li>
                </ul>
            </div>

            <div class="usuario">
                <span>Seja bem-vindo(a), <b>Gerente Geraldo Garcia <span id="nome_usuario"></span></b>
                </span>
            </div>

            <div class="logo">
                <img src="assets/imgs/LOGOcomTextoV2.png" alt="" width="150px">
            </div>
        </nav>

    </header>




    <!-- <section class="parte1"> -->


    <section>
        <div class="container-um">
            <div class="sessao">
                <div class="bloco-um">
                    <div class="maquinas">
                        <div class="titulo-off">
                            <span><b>Maquinas ligadas</b></span>
                        </div>
                        <div class="info-maquinas">
                            <div class="separar">
                                <img src="./assets/icon/desligar(1).png" alt="" style="width: 150px;">
                                <div class="dados-off">
                                    <span id="span_porcent_maquinas_ligadas">30%</span>
                                    <img src="./assets/icon/exclamacao.png" alt="" style="width: 60px; height: 60px;">
                                </div>
                            </div>
                            <div class="expandir"><button class="mais">Mostrar mais</button></div>
                        </div>
                    </div>
                </div>

                <div class="bloco-dois">
                    <div id="div_funcionarios" class="bg-funcionario">
                        <div class="titulo-funcionario">
                            <span><b>Funcionários</b></span>
                        </div>
                        <div class="lista-funcionario">
                            <ul id="ul_lista_funcionario">

                                <li class="funcionario">
                                    <div class="info-funcionario">
                                        <div class="conexao">
                                            <div class="status-funcionario" id=""><img
                                                    src="./assets/icon/circulo(1).png" alt="" style="width: 18px;">
                                            </div>
                                            <span id=""><b>Online</b> <b>desde ás 5h</b></span>
                                        </div>
                                        <div class="nome">
                                            <span>Fernando Brandão</span>
                                        </div>

                                        <div class="content-funcionario">
                                            <div class="mostrar">
                                                <div class="editar">
                                                    <button class="abrir-editar">
                                                        <div class="image-icon">
                                                            <img src="../public/assets/icon/lapis.png" alt=""
                                                                style="height: 22px;">
                                                        </div>
                                                    </button>
                                                </div>

                                                <div class="desativar">
                                                    <button class="abrir-desativar">
                                                        <div class="botao">
                                                            <div class="x"></div>
                                                        </div>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </li>

                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-dois">
            <div class="bloco-tres">
                <div class="titulo-execucao">
                    <span><b>Maquinas em tempo de execução</b></span>
                </div>
                <div class="time-container">
                    <div class="info-reloader">
                        <span><b>Próxima reinicialização:</b> 5 dias</span>
                        <button class="edit-date">Editar data</button>
                    </div>
                </div>
                <div class="temp-yes">
                    <ul id="ul_lista_maquinas" class="lista-maquina">
                        <li>
                            <div class="info-time">
                                <div class="sei-la">
                                    <div class="conexao-maquina">
                                        <div class="status-maquina" id=""><img src="./assets/icon/circulo.png" alt=""
                                                style="width: 18px;"></div>
                                        <span id=""><b>Offline</b></span>
                                    </div>
                                    <div class="nome-maquina">
                                        <span>Nome maquina</span>
                                    </div>
                                </div>
                                <button class="reload">Reiniciar</button>
                                <div class="time-reloader">
                                    <span><b>1d 10h 26min</b></span>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="bloco-quatro">
                <div class="grafico">
                    <div class="titulo-grafico">
                        <span><b>Horários de pico de consulmo de ram</b></span>
                    </div>
                    <div id="div_grafico" class="content-grafico">

                    </div>
                </div>
            </div>
        </div>
    </section>



    <div class="modal-parent1">
        <div class="modal-edit-funcionario">
            <div class="edit">
                <div class="titulo-edit">
                    <span><b>Editar funcionário</b></span>
                    <span>Fernando</span>
                </div>
                <div class="div">
                    <label><b>Novo email</b></label>
                    <input type="text">
                </div>

                <div class="div">
                    <label><b>Nova senha</b></label>
                    <input type="text">
                </div>

                <div class="texto-alerta" style="display: none;">
                    <span><b>Alterações salvas com sucesso</b></span>
                </div>

                <div class="opcao1">
                    <button class="btnS" id="save_edit"><b>Salvar</b></button>
                    <button class="btnN" id="cancel_edit"><b>Cancelar</b></button>
                </div>
            </div>
            <span class="X-1">&times;</span>
        </div>
    </div>

    <div class="modal-parent2" style="display: none;">
        <div class="modal-desativar">
            <div class="desativar">
                <div class="texto-desativar">
                    <span><b>Você deseja realmente desativar esse funcionário?</b></span>
                </div>
                <div class="opcao2">
                    <button class="btnS" id="save_deactivate"><b>Sim</b></button>
                    <button class="btnN" id="cancel_deactivate"><b>Não</b></button>
                </div>
            </div>
            <span class="X-2">&times;</span>
        </div>
    </div>


    <div class="modal-parent3">
        <div class="modal-mostrar-mais">
            <div class="mostrar-mais">
                <div class="titulo-lista">
                    <span>Lista de maquinas</span>
                </div>

                <div class="listar-mais">
                    <ul>
                        <li class="mais-maquinas">
                            <div class="info-saber-mais">
                                <div class="conexao-saber-mais">
                                    <div class="status-maquina" id=""><img src="./assets/icon/circulo(1).png" alt=""
                                            style="width: 18px;">
                                    </div>
                                    <span id=""><b>Online</b></span>
                                </div>
                                <div class="nome-maquina">
                                    <span>Caixa 52</span>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            <span class="X-3">&times;</span>
        </div>
    </div>

    <div class="modal-parent4">
        <div class="modal-editar-date-reniciar">
            <div class="editar-date">
                <div class="titulo-date">
                    <span><b>Editar data de reinicialização</b></span>
                </div>
                <div class="input-date">
                    <input type="date">
                </div>

                <div class="texto-alerta-date" style="display: none;">
                    <span><b>Alterações salvas com sucesso</b></span>
                </div>

                <div class="opcao2">
                    <button class="btnS" id="save_date"><b>Salvar</b></button>
                    <button class="btnN" id="cancel_date"><b>Cancelar</b></button>
                </div>
            </div>
            <span class="X-4">&times;</span>
        </div>
    </div>

    <div class="modal-parent5">
        <div class="modal-reiniciar">
            <div class="reiniciar">
                <div class="texto-reiniciar">
                    <span><b>Você deseja realmente reiniciar essa maquina?</b></span>
                </div>
                <div class="opcao2">
                    <button class="btnS" id="confirm_reiniciar"><b>Sim</b></button>
                    <button class="btnN" id="cancel_reiniciar"><b>Não</b></button>
                </div>
            </div>
            <span class="X-5">&times;</span>
        </div>
    </div>


    <script src="js/modal.js"></script>
    <!-- <script src="js/excluir.js"></script> -->
</body>

<script type="text/javascript">

    var lista_maquinas = document.getElementById("ul_cards_maquinas");

    function mostrarConteudo() {
        fetch("/datawatch/consultarStatusEmpresa", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idUsuarioServer: sessionStorage.ID_USUARIO
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                resposta.json().then(dados => {
                    console.log(dados)
                    // verifica se existe alguma empresa relacionada com esse usuário no banco de dados
                    // mostra o conteúdo da tela caso exista, não mostra caso não exista
                    if (dados.length == 0) {
                        alert("Nenhuma empresa cadastrada")
                    } else if (dados[0].verificado == 0) {
                        var idEmpresa = dados[0].fkEmpresa;

                    } else {
                        var idEmpresa = dados[0].fkEmpresa;
                        sessionStorage.ID_EMPRESA = idEmpresa
                        mostrarMaquinas(idEmpresa);
                        mostrarFuncionarios(idEmpresa);
                        pegarDadosGrafico(idEmpresa)
                    }
                })
            }
            else {
                throw (JSON.stringify(resposta))
            }
        }).catch(function (resposta) {
            console.log(`ERRO: ${resposta}`);
        })
        return false
    }

    function mostrarMaquinas(idEmpresa) {
        fetch("/datawatch/pegarMaquinas", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idEmpresaServer: idEmpresa
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                resposta.json().then(dados => {
                    console.log(dados)
                    var totalMaquinas = dados.length
                    var maquinasLigadas = 0
                    if (dados.length > 0) {
                        for (let i = 0; i < dados.length; i++) {
                            if (dados[i].statusSistema == 1) {
                                maquinasLigadas++
                            }
                        }
                        span_porcent_maquinas_ligadas.innerHTML = `${maquinasLigadas * 100 / totalMaquinas}%`

                        dados.forEach(maquina => {
                            carregarTempoAtivMaquinaTela(maquina)
                        })
                    }
                })
            }
            else {
                throw (JSON.stringify(resposta))
            }
        }).catch(function (resposta) {
            console.log(`ERRO: ${resposta}`);
        })
        return false
    }

    function mostrarFuncionarios(idEmpresa) {
        fetch("/datawatch/pegarFuncionarios", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idEmpresaServer: idEmpresa
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                resposta.json().then(dados => {
                    console.log(dados)
                    if (dados.length > 0) {
                        dados.forEach(funcionario => {
                            carregarFuncionarioTela(funcionario)

                        });
                    }
                })
            }
            else {
                throw (JSON.stringify(resposta))
            }
        }).catch(function (resposta) {
            console.log(`ERRO: ${resposta}`);
        })
        return false
    }

    function pegarDadosGrafico(idEmpresa) {
        fetch(`/datawatch/pegarDadosGrafico/${idEmpresa}`, {
            cache: 'no-store'
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(dadosMaquinas => {
                    console.log(dadosMaquinas)
                    if (dadosMaquinas.length > 0) {
                        drawChart(dadosMaquinas)
                    }
                })
            }
            else {
                throw (JSON.stringify(resposta))
            }
        }).catch(function (resposta) {
            console.log(`ERRO: ${resposta}`);
        })
        return false

    }

    function carregarFuncionarioTela(funcionario) {
        var liFuncionario = document.createElement("li")
        liFuncionario.setAttribute("class", "funcionario")

        var divInfoFuncionario = document.createElement("div")
        divInfoFuncionario.setAttribute("class", "info-funcionario")

        var divConexao = document.createElement("div")
        divConexao.setAttribute("class", "conexao")

        var divStatusFuncionario = document.createElement("div")
        divStatusFuncionario.setAttribute("class", "status-funcionario")

        var imgStatusFuncionario = document.createElement("img")

        var spanStatus = document.createElement("span")
        var bStatus = document.createElement("b")
        var bStatusHora = document.createElement("b")
        spanStatus.appendChild(bStatus)
        spanStatus.appendChild(bStatusHora)

        if (funcionario.statusUsuario == 1) {
            imgStatusFuncionario.src = "./assets/icon/circulo(1).png"
            bStatus.innerHTML = "Online"
        } else {
            imgStatusFuncionario.src = "./assets/icon/circulo(1).png"
            bStatus.innerHTML = "Offline"
        }
        imgStatusFuncionario.style = "width: 18px"


        var divNome = document.createElement("div")
        divNome.setAttribute("class", "nome")
        var spanNome = document.createElement("span")
        spanNome.innerHTML = funcionario.nomeUsuario

        divNome.appendChild(spanNome)

        var divContentFuncionario = document.createElement("div")
        divContentFuncionario.setAttribute("class", "content-funcionario")


        var divMostrar = document.createElement("div")
        divMostrar.setAttribute("class", "mostrar")

        var divEditar = document.createElement("div")
        divEditar.setAttribute("class", "editar")

        var btnEditar = document.createElement("button")
        btnEditar.setAttribute("class", "abrir-editar")

        var divImgEditar = document.createElement("div")
        divImgEditar.setAttribute("class", "image-icon")

        var imgLapisEditar = document.createElement("img")
        imgLapisEditar.src = "./assets/icon/lapis.png"
        imgLapisEditar.style = "height: 22px;"

        var divExcluir = document.createElement("div")
        divExcluir.setAttribute("class", "excluir")

        var btnExcluir = document.createElement("btn")
        btnExcluir.setAttribute("class", "abrir-excluir")

        var divBotaoX = document.createElement("div")
        divBotaoX.setAttribute("class", "botao")

        var divX = document.createElement("div")
        divX.setAttribute("class", "x")

        divBotaoX.appendChild(divX)
        btnExcluir.appendChild(divBotaoX)
        divExcluir.appendChild(btnExcluir)

        divImgEditar.appendChild(imgLapisEditar)
        btnEditar.appendChild(divImgEditar)
        divEditar.appendChild(btnEditar)

        divMostrar.appendChild(divEditar)
        divMostrar.appendChild(divExcluir)

        divContentFuncionario.appendChild(divMostrar)

        divStatusFuncionario.appendChild(imgStatusFuncionario)
        divStatusFuncionario.appendChild(spanStatus)

        divNome.appendChild(spanNome)

        divConexao.appendChild(divStatusFuncionario)

        divInfoFuncionario.appendChild(divConexao)
        divInfoFuncionario.appendChild(divNome)
        divInfoFuncionario.appendChild(divContentFuncionario)

        liFuncionario.appendChild(divInfoFuncionario)
        ul_lista_funcionario.appendChild(liFuncionario)
    }


    function carregarTempoAtivMaquinaTela(maquina) {
        var liMaquina = document.createElement("li")

        var divInfoTime = document.createElement("div")
        divInfoTime.setAttribute("class", "info-time")

        var divSeiLa = document.createElement("div")
        divSeiLa.setAttribute("class", "sei-la")

        var divConexaoMaquina = document.createElement("div")
        divConexaoMaquina.setAttribute("class", "conexao-maquina")

        var divStatusMaquina = document.createElement("div")
        divStatusMaquina.setAttribute("class", "status-maquina")

        var imgStatusMaquina = document.createElement("img")

        imgStatusMaquina.style = "width: 18px"

        var spanStatus = document.createElement("span")
        var bStatus = document.createElement("b")
        spanStatus.appendChild(bStatus)

        if (maquina.statusSistema == 1) {
            spanStatus.innerHTML = "Online"
            imgStatusMaquina.src = "./assets/icon/circulo(1).png"
        } else {
            spanStatus.innerHTML = "Offline"
            imgStatusMaquina.src = "./assets/icon/circulo.png"
        }

        var divNomeMaquina = document.createElement("div")
        divNomeMaquina.setAttribute("class", "nome-maquina")
        var spanNomeMaquina = document.createElement("span")
        spanNomeMaquina.innerHTML = maquina.nomeMaquina
        divNomeMaquina.appendChild(spanNomeMaquina)

        var btnReiniciar = document.createElement("button")
        btnReiniciar.setAttribute("class", "reload")
        btnReiniciar.innerHTML = "Reiniciar"

        var divTimeReload = document.createElement("div")
        divTimeReload.setAttribute("class", "time-reloader")

        var spanTimeReload = document.createElement("span")
        var bTimeReload = document.createElement("b")
        bTimeReload.innerHTML = `${maquina.tempo_formatado}`
        spanTimeReload.appendChild(bTimeReload)

        divTimeReload.appendChild(spanTimeReload)

        divStatusMaquina.appendChild(imgStatusMaquina)
        divConexaoMaquina.appendChild(divStatusMaquina)
        divConexaoMaquina.appendChild(spanStatus)

        divSeiLa.appendChild(divConexaoMaquina)
        divSeiLa.appendChild(divNomeMaquina)

        divInfoTime.appendChild(divSeiLa)
        divInfoTime.appendChild(btnReiniciar)
        divInfoTime.appendChild(divTimeReload)

        liMaquina.appendChild(divInfoTime)

        ul_lista_maquinas.appendChild(liMaquina)
    }



    google.charts.load("current", { packages: ['corechart'] });
    google.charts.setOnLoadCallback(drawChart);
    function drawChart(dados) {
        console.log(dados)
        var contQtdColunas = 0;
        var vetorInteiro = [['Nome máquina']]
        var ultimaHora = ''

        for (let i = 0; i < dados.length; i++) {
            if (vetorInteiro[0].indexOf(dados[i].nomeMaquina) == -1) {
                vetorInteiro[0].push(dados[i].nomeMaquina)
                contQtdColunas++
            }
            if (dados[i].HoraFormata != ultimaHora) {
                var vetor = [dados[i].HoraFormata]
                for (let j = 0; j < dados.length; j++) {
                    if (dados[j].HoraFormata == vetor[0]) {
                        vetor.push(dados[j].somaRam)
                    }
                }
                vetorInteiro.push(vetor)
                ultimaHora = dados[i].HoraFormata
            }
        }
        console.log(contQtdColunas)

        var vetorQtdColunas = [];
        for (let i = 0; i <= contQtdColunas; i++) {
            vetorQtdColunas.push(i)
        }

        console.log(vetor)

        console.log(vetorInteiro)

        var data = google.visualization.arrayToDataTable(vetorInteiro);

        var options = {
            width: "32vh",
            legend: { position: 'top', maxLines: 3 },
            bar: { groupWidth: '75%' },
            isStacked: true,
        };

        console.log(vetorQtdColunas)

        var view = new google.visualization.DataView(data);
        view.setColumns(vetorQtdColunas);

        var chart = new google.visualization.ColumnChart(document.getElementById("div_grafico"));
        chart.draw(view, options);
    }

    // Gráficos

    // google.charts.load('current', { 'packages': ['corechart'] });
    // google.charts.setOnLoadCallback(drawChart1);

    // function drawChart1() {

    //     var data = google.visualization.arrayToDataTable([
    //         ['Minutos', 'Tempo em Atividade'],
    //         ['', 0],
    //         ['', 88],
    //         ['', 144],
    //         ['', 0],
    //         ['', 32]
    //     ]);

    //     var options = {
    //         title: 'Tempo de funcionamento',
    //         curveType: 'function',
    //         legend: { position: 'bottom' }
    //     };

    //     var chart = new google.visualization.LineChart(document.getElementById('piechart1'));
    //     // confidencial = document.getElementById("RedeTitulo");


    //     chart.draw(data, options);
    // }

    // google.charts.load('current', { 'packages': ['corechart'] });
    // google.charts.setOnLoadCallback(drawChart2);

    // function drawChart2() {

    //     var data = google.visualization.arrayToDataTable([
    //         ['Minutos', 'Tempo em Atividade'],
    //         ['', 4],
    //         ['', 99],
    //         ['', 200],
    //         ['', 78],
    //         ['', 0]
    //     ]);

    //     var options = {
    //         title: 'Internet em kbps',
    //         curveType: 'function',
    //         legend: { position: 'bottom' }
    //     };

    //     var chart = new google.visualization.LineChart(document.getElementById('piechart2'));
    //     // confidencial = document.getElementById("RedeTitulo");


    //     chart.draw(data, options);
    // }

    // google.charts.load('current', { 'packages': ['corechart'] });
    // google.charts.setOnLoadCallback(drawChart3);

    // function drawChart3() {

    //     var data = google.visualization.arrayToDataTable([
    //         ['Minutos', 'Tempo em Atividade'],
    //         ['', 42],
    //         ['', 444],
    //         ['', 25],
    //         ['', 75],
    //         ['', 65]
    //     ]);

    //     var options = {
    //         title: 'Internet em kbps',
    //         curveType: 'function',
    //         legend: { position: 'bottom' }
    //     };

    //     var chart = new google.visualization.LineChart(document.getElementById('piechart3'));
    //     // confidencial = document.getElementById("RedeTitulo");


    //     chart.draw(data, options);
    // }

    // google.charts.load('current', { 'packages': ['corechart'] });
    // google.charts.setOnLoadCallback(drawChart4);

    // function drawChart4() {

    //     var data = google.visualization.arrayToDataTable([
    //         ['Minutos', 'Tempo em Atividade'],
    //         ['', 0],
    //         ['', 324],
    //         ['', 245],
    //         ['', 75],
    //         ['', 86]
    //     ]);

    //     var options = {
    //         title: 'Internet em kbps',
    //         curveType: 'function',
    //         legend: { position: 'bottom' }
    //     };

    //     var chart = new google.visualization.LineChart(document.getElementById('piechart4'));
    //     // confidencial = document.getElementById("RedeTitulo");


    //     chart.draw(data, options);
    // }

</script>