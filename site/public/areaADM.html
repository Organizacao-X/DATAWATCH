<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>DATAWATCH | Administração</title>

    <script src="./js/funcoes.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <link rel="icon" href="./assets/imgs/LOGOV2.png">
    <link rel="stylesheet" href="./css/areaADM.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
</head>

<!-- <body onload="mostrarConteudo()" onload="drawChart()"> -->

<body onload="mostrarConteudo()">
    <!-- NAVBAR -->
    <header>
        <nav class="nav-bar">
            <div class="hamburger-menu">
                <input id="menu__toggle" type="checkbox">
                <label class="menu__btn" for="menu__toggle">
                    <span></span>
                </label>



                <ul class="menu__box" id="menu__box">
                    <div class="image">
                        <img src="./assets/imgs/imagem-do-usuario-com-fundo-preto.png" alt=""
                            style="height: 200px; width: 200px; ">
                    </div>
                    <div class="nomeUser">
                        <span id="lateral_menu_adm_name"></span>
                    </div>
                    <li id="lateral_menu_cad_empresa" style="display: none;"><a class="menu__item"
                            href="./cadastroEmpresa.html">Cadastrar
                            empresa</a></li>
                    <li><a class="menu__item" href="./areaADM.html">Home</a></li>
                    <li id="lateral_menu_cad_diretor"><a class="menu__item">Vincular um diretor</a></li>
                    <li id="lateral_menu_cad_funcionario"><a class="menu__item"
                            href="./cadastroFuncionario.html">Cadastrar funcionário</a></li>
                    <li onclick="abrirModalBaixar()"><span class="menu__item">Baixar aplicativo</span></li>
                    <li><a class="menu__item" href="#" onclick="limparSessao()">Logout</a></li>
                    <li><a class="menu__item" target="_blank"
                            href="https://datawattch.atlassian.net/servicedesk/customer/portal/2">Suporte</a></li>
                </ul>
            </div>

            <div class="usuario">
                <span>Seja bem-vindo(a), <b>Gerente <span id="nome_usuario"></span></b>
                </span>
            </div>

            <div class="logo">
                <img src="assets/imgs/LOGOcomTextoV2.png" alt="" width="150px">
            </div>
        </nav>

    </header>




    <!-- <section class="parte1"> -->


    <section>
        <div class="container-um">
            <div class="sessao">
                <div class="bloco-um">
                    <div class="maquinas">
                        <div class="titulo-off">
                            <span><b>Maquinas ligadas</b></span>
                        </div>
                        <div class="info-maquinas">
                            <div class="separar">
                                <img src="./assets/icon/desligar(1).png" alt="" style="width: 150px;">
                                <div class="dados-off">
                                    <span id="span_porcent_maquinas_ligadas"></span>
                                    <img src="./assets/icon/exclamacao.png" alt="" style="width: 60px; height: 60px;">
                                </div>
                            </div>
                            <div class="expandir"><button class="mais">Mostrar mais</button></div>
                        </div>
                    </div>
                </div>

                <div class="bloco-dois">
                    <div id="div_funcionarios" class="bg-funcionario">
                        <div class="titulo-funcionario">
                            <span><b>Funcionários</b></span>
                        </div>
                        <div class="lista-funcionario">
                            <ul id="ul_lista_funcionario">

                                <!-- <li class="funcionario">
                                    <div class="info-funcionario">
                                        <div class="conexao">
                                            <div class="status-funcionario" id=""><img
                                                    src="./assets/icon/circulo(1).png" alt="" style="width: 18px;">
                                            </div>
                                            <span id=""><b>Online</b> <b>desde ás 5h</b></span>
                                        </div>
                                        <div class="nome">
                                            <span>Fernando Brandão</span>
                                        </div>

                                        <div class="content-funcionario">
                                            <div class="mostrar">
                                                <div class="editar">
                                                    <button class="abrir-editar">
                                                        <div class="image-icon">
                                                            <img src="../public/assets/icon/lapis.png" alt=""
                                                                style="height: 22px;">
                                                        </div>
                                                    </button>
                                                </div>

                                                <div class="desativar">
                                                    <button class="abrir-desativar">
                                                        <div class="botao">
                                                            <div class="x"></div>
                                                        </div>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </li> -->

                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-dois">
            <div class="bloco-tres">
                <div class="titulo-execucao">
                    <span><b>Maquinas em tempo de execução</b></span>
                </div>

                <div class="temp-yes">
                    <ul id="ul_lista_maquinas" class="lista-maquina">
                        <!-- <li>
                            <div class="info-time">
                                <div class="sei-la">
                                    <div class="conexao-maquina">
                                        <div class="status-maquina" id=""><img src="./assets/icon/circulo.png" alt=""
                                                style="width: 18px;"></div>
                                        <span id=""><b>Offline</b></span>
                                    </div>
                                    <div class="nome-maquina">
                                        <span>Nome maquina</span>
                                    </div>
                                </div>
                                <button class="reload">Reiniciar</button>
                                <div class="time-reloader">
                                    <span><b>1d 10h 26min</b></span>
                                </div>
                            </div>
                        </li> -->
                    </ul>
                </div>
            </div>
            <div class="bloco-quatro">
                <div class="grafico">
                    <div class="titulo-grafico">
                        <span><b>Horários de pico de consumo de RAM - Últimos 30 dias</b></span>
                    </div>
                    <div id="div_grafico" class="content-grafico">

                    </div>
                </div>
                <div id="container_kpi"><span><b id="b_titulo">TOP 3 HORARIOS DE PICO</b></span>
                    <div id="kpi_grafico"><span id="kpi1"></span><span id="kpi2"></span><span id="kpi3"></span></div>
                </div>
            </div>
        </div>
    </section>



    <div class="modal-parent1">
        <div class="modal-edit-funcionario">
            <div class="edit">
                <div class="titulo-edit">
                    <span><b>Editar funcionário</b></span>
                    <span id="span_nome_funcionario"></span>
                </div>
                <div class="div">
                    <label><b>Novo email</b></label>
                    <input type="text" id="ipt_mudar_email">
                </div>

                <div class="div">
                    <label><b>Nova senha</b></label>
                    <input type="text" id="ipt_mudar_senha">
                </div>

                <div id="div_func_saved" class="texto-alerta" style="display: none;">
                    <span><b>Alterações salvas com sucesso</b></span>
                </div>

                <div class="opcao1">
                    <button class="btnS" id="save_edit" onclick="salvarEditar()"><b>Salvar</b></button>
                    <button class="btnN" id="cancel_edit"><b>Cancelar</b></button>
                </div>
            </div>
            <span class="X-1">&times;</span>
        </div>
    </div>

    <div class="modal-parent2" style="display: none;">
        <div class="modal-desativar">
            <div class="desativar">
                <div class="texto-desativar">
                    <span><b>Você deseja realmente desativar esse funcionário?</b></span>
                </div>
                <div class="opcao2">
                    <button class="btnS" id="save_deactivate" onclick="desativarFuncionario()"><b>Sim</b></button>
                    <button class="btnN" id="cancel_deactivate"><b>Não</b></button>
                </div>
            </div>
            <span class="X-2">&times;</span>
        </div>
    </div>


    <div class="modal-parent3">
        <div class="modal-mostrar-mais">
            <div class="mostrar-mais">
                <div class="titulo-lista">
                    <span>Lista de maquinas</span>
                </div>

                <div class="listar-mais">
                    <ul>
                        <li class="mais-maquinas" id="mais_maquinas">
                            <!-- <div class="info-saber-mais">
                                <div class="conexao-saber-mais">
                                    <div class="status-maquina" id=""><img src="./assets/icon/circulo(1).png" alt=""
                                            style="width: 18px;">
                                    </div>
                                    <span id=""><b>Online</b></span>
                                </div>
                                <div class="nome-maquina">
                                    <span id="todasMaquinas">Caixa 52</span>
                                </div>
                            </div> -->
                        </li>
                    </ul>
                </div>
            </div>
            <span class="X-3">&times;</span>
        </div>
    </div>

    <div class="modal-parent4">
        <div class="modal-editar-date-reniciar">
            <div class="editar-date">
                <div class="titulo-date">
                    <span><b>Editar data de reinicialização</b></span>
                </div>
                <div class="input-date">
                    <input type="date">
                </div>

                <div class="texto-alerta-date" style="display: none;">
                    <span><b>Alterações salvas com sucesso</b></span>
                </div>

                <div class="opcao2">
                    <button class="btnS" id="save_date"><b>Salvar</b></button>
                    <button class="btnN" id="cancel_date"><b>Cancelar</b></button>
                </div>
            </div>
            <span class="X-4">&times;</span>
        </div>
    </div>

    <div class="modal-parent5">
        <div class="modal-reiniciar">
            <div class="reiniciar">
                <div class="texto-reiniciar">
                    <span><b>Você deseja realmente reiniciar essa maquina?</b></span>
                </div>
                <div class="opcao2">
                    <button class="btnS" id="confirm_reiniciar" onclick="rebootar(this.value)"><b>Sim</b></button>
                    <button class="btnN" id="cancel_reiniciar"><b>Não</b></button>
                </div>
            </div>
            <span class="X-5">&times;</span>
        </div>
    </div>


    <div class="modal-parent6">
        <div class="modal-diretor">
            <div class="diretor">
                <div class="texto-diretor">
                    <span><b>Cole o código do seu diretor no campo abaixo</b></span>
                    <input type="text" id="codigo_diretor">
                </div>
                <div class="opcao2">
                    <button class="btnS" id="vincular_diretor" onclick="vincularDiretor()"><b>Vincular</b></button>
                </div>
            </div>
            <span class="X-6">&times;</span>
        </div>
    </div>

    <div class="modal-parent7">
        <div class="modal-download1">
            <div class="baixar1">
                <div class="texto-baixar1">
                    <div class="decoracao">
                        <span><b>Download</b></span>
                        <div class="linha"></div>
                    </div>
                    <div class="img-baixar">
                        <img src="./assets/icon/arrow.png" alt="" style="width: 150px;">
                    </div>
                </div>
                <div class="texto-dois">
                    <div class="container">
                        <div class="tabs">
                            <input type="radio" id="radio-1" name="tabs" checked="">
                            <button
                                onclick="downloadFile('./JAR/ARCH-01/DATAWATCH-ARCH-01.sh', 'DATAWATCH-ARCH-01.sh')"><label
                                    class="tab" for="radio-1" id="um">Datawatch Nativo</label></button>
                            <input type="radio" id="radio-2" name="tabs">
                            <button
                                onclick="downloadFile('./JAR/ARCH-03/DATAWATCH-ARCH-03.sh', 'DATAWATCH-ARCH-03.sh')"><label
                                    class="tab" for="radio-2" id="um">Datawatch Container</label></button>
                            <span class="glider"></span>
                        </div>
                    </div>
                </div>
            </div>
            <span class="X-7">&times;</span>
        </div>
    </div>

    <!-- <script src="js/modal.js"></script> -->
    <!-- <script src="js/excluir.js"></script> -->
</body>

<script type="text/javascript">
    nome_usuario.innerHTML = `${sessionStorage.NOME_USUARIO}`

    const agora = new Date();

    function rebootar(idMaquina) {

        fetch(`/datawatch/rebootar`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idMaquinaServer: idMaquina,
                fkEmpresaServer: sessionStorage.ID_EMPRESA
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                window.alert("Máquina reiniciada com sucesso!");
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar rebootar a máquina: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    var lista_maquinas = document.getElementById("ul_cards_maquinas");


    function salvarEditar() {
        var novo_email = ipt_mudar_email.value
        var nova_senha = ipt_mudar_senha.value

        fetch(`/datawatch/editarFuncionario/${sessionStorage.ID_FUNCIONARIO}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                novoEmailServer: novo_email,
                novaSenhaServer: nova_senha,
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                // console.log("ok")
                div_func_saved.style.display = "block"
                // hideModalWithSaveEditar()
                // limparCampos(inputs)
            }
            // } else if (resposta.status == 404) {
            //     window.alert("Deu 404!");
            // } else {
            //     throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            // }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    function desativarFuncionario() {
        fetch(`/datawatch/desativarFuncionario/${sessionStorage.ID_FUNCIONARIO}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            console.log(resposta)
            if (resposta.ok) {
                // console.log("deletado com sucesso")
                mostrarFuncionarios(sessionStorage.ID_EMPRESA)
            }
            // } else if (resposta.status == 404) {
            //     window.alert("Deu 404!");
            // } else {
            //     throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            // }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }


    const $ = document
    let modalEditarFuncionario, modalDesativarFuncionario, modalMostrarMais, modalEditarDateReiniciar,
        modalReiniciar, buttonMostrarMais, x3, buttonEditFuncionario, buttonDesativarFuncionario,
        buttonSalvarEdit, buttonCancelarEdit, buttonConfirmDesativar, buttonCancelarDesativar, x1, x2,
        buttonEditarDateReiniciar, buttonReiniciar, buttonConfirmReiniciar, buttonCancelarReiniciar, buttonSalvarEditDate, buttonCancelarEditDate, x4, x5

    const modalBaixar = $.querySelector('.modal-parent7');
    const x7 = $.querySelector('.X-7');
    let sessaoElem = $.querySelector('section')

    function downloadFile(url, fileName) {
        var link = document.createElement('a');
        link.href = url;
        link.download = fileName;
        link.click();
    }

    function toggleCheckbox() {
        var checkbox = document.getElementById("menu__toggle");
        checkbox.checked = !checkbox.checked;
    }

    function abrirModalBaixar() {
        modalBaixar.style.display = 'block'
        sessaoElem.style.filter = 'blur(10px)'
        toggleCheckbox()
    }

    function fecharModalBaixarComX() {
        modalBaixar.style.display = 'none'
        sessaoElem.style.filter = 'blur(0px)'
    }

    function fecharModalBaixarComEsc(event) {
        if (event.keyCode === 27) {
            modalBaixar.style.display = 'none'
            sessaoElem.style.filter = 'blur(0px)'
        }
    }

    x7.addEventListener('click', fecharModalBaixarComX)
    document.body.addEventListener('keyup', fecharModalBaixarComEsc)

    function carregarFuncoesModal() {
        // console.log("Modais carregados")
        // modais
        modalEditarFuncionario = $.querySelector('.modal-parent1');
        modalDesativarFuncionario = $.querySelector('.modal-parent2');
        modalMostrarMais = $.querySelector('.modal-parent3');
        modalEditarDateReiniciar = $.querySelector('.modal-parent4');
        modalReiniciar = $.querySelector('.modal-parent5');


        // sessão
        sessaoElem = $.querySelector('section');

        // Maquina lista
        buttonMostrarMais = $.querySelector('.mais');
        x3 = $.querySelector('.X-3');

        buttonMostrarMais.addEventListener('click', abrirModalMostrarMais)
        x3.addEventListener('click', fecharModalMostrarMaisComX)
        document.body.addEventListener('keyup', fecharModalMostrarMaisComEsc)

        // funcionarios
        buttonEditFuncionario = $.querySelectorAll('.abrir-editar');
        buttonDesativarFuncionario = $.querySelectorAll('.abrir-desativar');

        // console.log(buttonEditFuncionario)
        // console.log(buttonDesativarFuncionario)

        buttonSalvarEdit = $.querySelector('#save_edit');
        buttonCancelarEdit = $.querySelector('#cancel_edit');

        buttonConfirmDesativar = $.querySelector('#save_deactivate')
        buttonCancelarDesativar = $.querySelector('#cancel_deactivate')

        x1 = $.querySelector(".X-1");
        x2 = $.querySelector('.X-2');

        buttonEditFuncionario.forEach(botao => {
            botao.addEventListener('click', abrirModalEditarFuncionario)
        })
        x1.addEventListener('click', fecharModalEditarFuncionarioComX)
        document.body.addEventListener('keyup', fecharModalEditarFuncionarioComEsc)

        x1.addEventListener('click', fecharModalEditarFuncionarioComX)
        buttonCancelarEdit.addEventListener('click', fecharModalEditarFuncionarioComX)

        buttonDesativarFuncionario.forEach(botao => {
            botao.addEventListener('click', abrirModalDesativarFuncionario)
        })
        x2.addEventListener('click', fecharModalDesativarFuncionarioComX)
        document.body.addEventListener('keyup', fecharModalDesativarFuncionarioComEsc)

        buttonConfirmDesativar.addEventListener('click', fecharModalDesativarFuncionarioComX)
        buttonCancelarDesativar.addEventListener('click', fecharModalDesativarFuncionarioComX)

        // buttonEditarDateReiniciar = $.querySelector('.edit-date');
        buttonReiniciar = $.querySelectorAll('.reload');

        buttonConfirmReiniciar = $.querySelector('#confirm_reiniciar')
        buttonCancelarReiniciar = $.querySelector('#cancel_reiniciar')

        buttonSalvarEditDate = $.querySelector('#save_date')
        buttonCancelarEditDate = $.querySelector('#cancel_date')

        x4 = $.querySelector('.X-4');
        x5 = $.querySelector(".X-5");

        // buttonEditarDateReiniciar.addEventListener('click', abrirModalEditarDateReiniciar)
        // x4.addEventListener('click', fecharModalEditarDateReiniciarComX)
        // document.body.addEventListener('keyup', fecharModalEditarDateReiniciarComEsc)

        // buttonSalvarEditDate.addEventListener('click', fecharModalEditarDateReiniciarComX)
        // buttonCancelarEditDate.addEventListener('click', fecharModalEditarDateReiniciarComX)

        buttonReiniciar.forEach(botao => {
            botao.addEventListener('click', abrirModalReiniciar)
        });

        x5.addEventListener('click', fecharModalReiniciarComX)
        document.body.addEventListener('keyup', fecharModalReiniciarComEsc)

        buttonConfirmReiniciar.addEventListener('click', fecharModalReiniciarComX)
        buttonCancelarReiniciar.addEventListener('click', fecharModalReiniciarComX)
    }

    function abrirModalReiniciar() {
        modalReiniciar.style.display = 'block'
        sessaoElem.style.filter = 'blur(10px)'
        buttonReiniciar.blur()
    }

    function fecharModalReiniciarComX() {
        modalReiniciar.style.display = 'none'
        sessaoElem.style.filter = 'blur(0px)'
    }

    function fecharModalReiniciarComEsc(event) {
        if (event.keyCode === 27) {
            modalReiniciar.style.display = 'none'
            sessaoElem.style.filter = 'blur(0px)'
        }
    }

    function abrirModalEditarDateReiniciar() {
        modalEditarDateReiniciar.style.display = 'block'
        sessaoElem.style.filter = 'blur(10px)'
        buttonEditarDateReiniciar.blur()
    }

    function fecharModalEditarDateReiniciarComX() {
        modalEditarDateReiniciar.style.display = 'none'
        sessaoElem.style.filter = 'blur(0px)'
    }

    function fecharModalEditarDateReiniciarComEsc(event) {
        if (event.keyCode === 27) {
            modalEditarDateReiniciar.style.display = 'none'
            sessaoElem.style.filter = 'blur(0px)'
        }
    }

    function abrirModalDesativarFuncionario() {
        modalDesativarFuncionario.style.display = 'block'
        sessaoElem.style.filter = 'blur(10px)'
        buttonDesativarFuncionario.blur()
    }

    function fecharModalDesativarFuncionarioComX() {
        modalDesativarFuncionario.style.display = 'none'
        sessaoElem.style.filter = 'blur(0px)'
    }

    function fecharModalDesativarFuncionarioComEsc(event) {
        if (event.keyCode === 27) {
            modalDesativarFuncionario.style.display = 'none'
            sessaoElem.style.filter = 'blur(0px)'
        }
    }

    function abrirModalEditarFuncionario() {
        modalEditarFuncionario.style.display = 'block'
        sessaoElem.style.filter = 'blur(10px)'
        div_func_saved.style.display = 'none'
        ipt_mudar_email.value = ''
        ipt_mudar_senha.value = ''
        buttonEditFuncionario.blur()
    }

    function fecharModalEditarFuncionarioComX() {
        modalEditarFuncionario.style.display = 'none'
        sessaoElem.style.filter = 'blur(0px)'
    }

    function fecharModalEditarFuncionarioComEsc(event) {
        if (event.keyCode === 27) {
            modalEditarFuncionario.style.display = 'none'
            sessaoElem.style.filter = 'blur(0px)'
        }
    }

    function fecharModalMostrarMaisComEsc(event) {
        if (event.keyCode === 27) {
            modalMostrarMais.style.display = 'none'
            sessaoElem.style.filter = 'blur(0px)'
        }
    }


    function abrirModalMostrarMais() {
        modalMostrarMais.style.display = 'block'
        sessaoElem.style.filter = 'blur(10px)'
        buttonMostrarMais.blur()
    }

    function fecharModalMostrarMaisComX() {
        modalMostrarMais.style.display = 'none'
        sessaoElem.style.filter = 'blur(0px)'
    }

    const modalCodigoDiretor = $.querySelector(".modal-parent6");
    const buttonDiretor = $.querySelector("#lateral_menu_cad_diretor");
    const x6 = $.querySelector(".X-6");

    function abrirModalDiretor() {
        modalCodigoDiretor.style.display = 'block';
        sessaoElem.style.filter = 'blur(10px)'
        buttonDiretor.blur();
    }

    function fecharModalDiretorComX() {
        modalCodigoDiretor.style.display = 'none'
        sessaoElem.style.filter = 'blur(0px)'
    }

    function fecharModalDiretorComEsc(event) {
        if (event.keyCode === 27) {
            modalCodigoDiretor.style.display = 'none'
            sessaoElem.style.filter = 'blur(0px)'
        }
    }

    buttonDiretor.addEventListener('click', abrirModalDiretor)
    x6.addEventListener('click', fecharModalDiretorComX)
    document.body.addEventListener('keyup', fecharModalDiretorComEsc)

    function mostrarConteudo() {
        fetch("/datawatch/consultarStatusEmpresa", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idUsuarioServer: sessionStorage.ID_USUARIO
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                resposta.json().then(dados => {
                    // console.log(dados)
                    // verifica se existe alguma empresa relacionada com esse usuário no banco de dados
                    // mostra o conteúdo da tela caso exista, não mostra caso não exista
                    if (dados.length == 0) {
                        alert("Nenhuma empresa cadastrada")
                    } else if (dados[0].verificado == 0) {
                        var idEmpresa = dados[0].fkEmpresa;
                    } else {
                        var idEmpresa = dados[0].fkEmpresa;
                        sessionStorage.ID_EMPRESA = idEmpresa
                        // mostrarMaquinas(idEmpresa);
                        mostrarFuncionarios(idEmpresa);
                        pegarDadosGrafico(idEmpresa)
                        atualizarStatusMaquinas(idEmpresa)
                    }
                })
            }
            else {
                throw (JSON.stringify(resposta))
            }
        }).catch(function (resposta) {
            console.log(`ERRO: ${resposta}`);
        })
        return false
    }

    function atualizarStatusMaquinas(idEmpresa) {
        fetch(`/datawatch/atualizarStatusMaquinas/${idEmpresa}`, {
            cache: 'no-store'
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(statusMaquinas => {
                    // console.log(dados)
                    // if (timeoutMaquinas != undefined) {
                    //     clearTimeout(timeoutMaquinas)
                    // }
                    mostrarMaquinas(idEmpresa, statusMaquinas)
                })
            }
        }).catch(function (resposta) {
            console.log(`Erro: ${resposta}`)
        })
        return false
    }

    let timeoutMaquinas;

    function mostrarMaquinas(idEmpresa, statusMaquinas) {
        fetch("/datawatch/pegarMaquinas", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idEmpresaServer: idEmpresa
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                resposta.json().then(dados => {
                    // console.log(dados)
                    var totalMaquinas = dados.length
                    var maquinasLigadas = 0
                    if (dados.length > 0) {
                        mais_maquinas.innerHTML = ''
                        console.log(statusMaquinas)
                        console.log(dados)
                        ul_lista_maquinas.innerHTML = ''
                        let i = 0
                        dados.forEach(maquina => {
                            statusMaquinas.forEach(linha => {
                                if (maquina.nomeMaquina == linha.nomeMaquina) {
                                    if (linha.segundos_desde_lastinsert > 40) {
                                        maquina.statusSistema = 0;
                                    } else {
                                        maquina.statusSistema = 1;
                                    }
                                }
                            })
                            mais_maquinas.innerHTML += `<div class="info-saber-mais">
                                <div class="conexao-saber-mais">
                                    <div class="status-maquina" id="img${i}">
                                    </div>
                                    <span id="status${i}"></span>
                                </div>
                                <div class="nome-maquina">
                                    <span id="todasMaquinas">${maquina.nomeMaquina}</span>
                                </div>
                            </div>`
                            const statusSpan = document.getElementById(`status${i}`);
                            const statusImg = document.getElementById(`img${i}`);
                            if (maquina.statusSistema == 1) {
                                statusImg.innerHTML = `<img src="./assets/icon/circulo(1).png" alt=""
                                            style="width: 18px;">`
                                statusSpan.innerHTML += `<b>Online</b>`
                                maquinasLigadas++
                            } else {
                                statusImg.innerHTML = `<img src="./assets/icon/circulo.png" alt=""
                                            style="width: 18px;">`
                                statusSpan.innerHTML += `<b>Offline</b>`
                            }
                            i++
                            carregarTempoAtivMaquinaTela(maquina)
                        })
                    }
                    span_porcent_maquinas_ligadas.innerHTML = `${(maquinasLigadas * 100 / totalMaquinas).toFixed(0)}%`
                    // console.log(idEmpresa)
                    timeoutMaquinas = setTimeout(() => atualizarStatusMaquinas(idEmpresa), 30000);
                })
            }
            else {
                throw (JSON.stringify(resposta))
            }
        }).catch(function (resposta) {
            console.log(`ERRO: ${resposta}`);
        })
        return false
    }

    function mostrarFuncionarios(idEmpresa) {
        fetch("/datawatch/pegarFuncionarios", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idEmpresaServer: idEmpresa
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                resposta.json().then(dados => {
                    // console.log(dados)
                    ul_lista_funcionario.innerHTML = ''
                    if (dados.length > 0) {
                        dados.forEach(funcionario => {
                            carregarFuncionarioTela(funcionario)
                        });
                        carregarFuncoesModal()
                    }
                })
            }
            else {
                throw (JSON.stringify(resposta))
            }
        }).catch(function (resposta) {
            console.log(`ERRO: ${resposta}`);
        })
        return false
    }

    function pegarDadosGrafico(idEmpresa) {
        fetch(`/datawatch/pegarDadosGraficoEmpilhado/${idEmpresa}`, {
            cache: 'no-store'
        }).then(function (resposta) {
            if (resposta.ok) {
                console.log("aqui envia")
                maiorConsumoRam(idEmpresa)
                resposta.json().then(dadosMaquinas => {
                    // console.log(dadosMaquinas)
                    if (dadosMaquinas.length > 0) {
                        drawChart(dadosMaquinas)

                    }
                })
            }
            else {
                throw (JSON.stringify(resposta))
            }
        }).catch(function (resposta) {
            console.log(`ERRO: ${resposta}`);
        })
        return false

    }

    function maiorConsumoRam(idEmpresa) {
        console.log("aqui chega")
        fetch(`/datawatch/maiorConsumoRam/${idEmpresa}`, {
            cache: 'no-store'
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(registro => {
                    kpi1.innerHTML = `<b>1º:</b> ${registro[0].horaPico} Hrs com ${(registro[0].somaram).toFixed(2)} GBs`
                    kpi2.innerHTML = `<b>2º:</b> ${registro[1].horaPico} Hrs com ${(registro[1].somaram).toFixed(2)} GBs`
                    kpi3.innerHTML = `<b>3º:</b> ${registro[2].horaPico} Hrs com ${(registro[2].somaram).toFixed(2)} GBs`

                })
            }
            else {
                throw (JSON.stringify(resposta))
            }
        }).catch(function (resposta) {
            console.log(`ERRO: ${resposta}`);
        })
        return false

    }

    function carregarFuncionarioTela(funcionario) {
        console.log(funcionario)
        /*
<li class="funcionario">
    <div class="info-funcionario">
        <div class="conexao">
            <div class="status-funcionario" id="">
                <img src="./assets/icon/circulo(1).png" alt="" style="width: 18px;">
            </div>
            <span id=""><b>Online</b> <b>desde ás 5h</b></span>
        </div>
        <div class="nome">
            <span>Fernando Brandão</span>
        </div>
        <div class="content-funcionario">
            <div class="mostrar">
                <div class="editar">
                    <button class="abrir-editar">
                        <div class="image-icon">
                            <img src="../public/assets/icon/lapis.png" alt="" style="height: 22px;">
                        </div>
                    </button>
                </div>
                <div class="desativar">
                    <button class="abrir-desativar">
                        <div class="botao">
                            <div class="x"></div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
</li>
        */
        var liFuncionario = document.createElement("li")
        liFuncionario.setAttribute("class", "funcionario")

        var divInfoFuncionario = document.createElement("div")
        divInfoFuncionario.setAttribute("class", "info-funcionario")

        var divConexao = document.createElement("div")
        divConexao.setAttribute("class", "conexao")

        var divStatusFuncionario = document.createElement("div")
        divStatusFuncionario.setAttribute("class", "status-funcionario")

        var imgStatusFuncionario = document.createElement("img")

        var spanStatus = document.createElement("span")
        var bStatus = document.createElement("b")
        var bStatusHora = document.createElement("b")
        spanStatus.appendChild(bStatus)
        spanStatus.appendChild(bStatusHora)

        if (funcionario.isDiretor == 0) {
            imgStatusFuncionario.src = "./assets/icon/user.png"
            bStatus.innerHTML = "Funcionário"
        } else {
            imgStatusFuncionario.src = "./assets/icon/profile.png"
            bStatus.innerHTML = "Diretor"
        }
        imgStatusFuncionario.style = "width: 18px"


        var divNome = document.createElement("div")
        divNome.setAttribute("class", "nome")
        var spanNome = document.createElement("span")
        spanNome.innerHTML = funcionario.nomeUsuario

        divNome.appendChild(spanNome)

        var divContentFuncionario = document.createElement("div")
        divContentFuncionario.setAttribute("class", "content-funcionario")


        var divMostrar = document.createElement("div")
        divMostrar.setAttribute("class", "mostrar")

        var divEditar = document.createElement("div")
        divEditar.setAttribute("class", "editar")

        var btnEditar = document.createElement("button")
        btnEditar.setAttribute("class", "abrir-editar")

        var divImgEditar = document.createElement("div")
        divImgEditar.setAttribute("class", "image-icon")

        var imgLapisEditar = document.createElement("img")
        imgLapisEditar.src = "./assets/icon/lapis.png"
        imgLapisEditar.style = "height: 22px;"

        var divExcluir = document.createElement("div")
        divExcluir.setAttribute("class", "excluir")

        var btnExcluir = document.createElement("btn")
        btnExcluir.setAttribute("class", "abrir-desativar")

        var divBotaoX = document.createElement("div")
        divBotaoX.setAttribute("class", "botao")

        var divX = document.createElement("div")
        divX.setAttribute("class", "x")

        btnEditar.setAttribute('value', funcionario.idUsuario)

        btnEditar.addEventListener('click', function () {
            sessionStorage.ID_FUNCIONARIO = btnEditar.getAttribute('value')
        })

        btnExcluir.setAttribute('value', funcionario.idUsuario)

        btnExcluir.addEventListener('click', function () {
            sessionStorage.ID_FUNCIONARIO = btnExcluir.getAttribute('value')
        })

        divBotaoX.appendChild(divX)
        btnExcluir.appendChild(divBotaoX)
        divExcluir.appendChild(btnExcluir)

        divImgEditar.appendChild(imgLapisEditar)
        btnEditar.appendChild(divImgEditar)
        divEditar.appendChild(btnEditar)

        divMostrar.appendChild(divEditar)
        divMostrar.appendChild(divExcluir)

        divContentFuncionario.appendChild(divMostrar)

        divStatusFuncionario.appendChild(imgStatusFuncionario)
        divStatusFuncionario.appendChild(spanStatus)

        divNome.appendChild(spanNome)

        divConexao.appendChild(divStatusFuncionario)

        divInfoFuncionario.appendChild(divConexao)
        divInfoFuncionario.appendChild(divNome)
        divInfoFuncionario.appendChild(divContentFuncionario)

        liFuncionario.appendChild(divInfoFuncionario)
        // console.log(liFuncionario)
        ul_lista_funcionario.appendChild(liFuncionario)
    }


    function carregarTempoAtivMaquinaTela(maquina) {
        var liMaquina = document.createElement("li")

        var divInfoTime = document.createElement("div")
        divInfoTime.setAttribute("class", "info-time")

        var divSeiLa = document.createElement("div")
        divSeiLa.setAttribute("class", "sei-la")

        var divConexaoMaquina = document.createElement("div")
        divConexaoMaquina.setAttribute("class", "conexao-maquina")

        var divStatusMaquina = document.createElement("div")
        divStatusMaquina.setAttribute("class", "status-maquina")

        var imgStatusMaquina = document.createElement("img")

        imgStatusMaquina.style = "width: 18px"

        var spanStatus = document.createElement("span")
        var bStatus = document.createElement("b")
        spanStatus.appendChild(bStatus)

        if (maquina.statusSistema == 1) {
            spanStatus.innerHTML = "Online"
            imgStatusMaquina.src = "./assets/icon/circulo(1).png"
        } else {
            spanStatus.innerHTML = "Offline"
            imgStatusMaquina.src = "./assets/icon/circulo.png"
        }

        var divNomeMaquina = document.createElement("div")
        divNomeMaquina.setAttribute("class", "nome-maquina")
        var spanNomeMaquina = document.createElement("span")
        spanNomeMaquina.innerHTML = maquina.nomeMaquina
        divNomeMaquina.appendChild(spanNomeMaquina)

        /* ---- BOTÃO REINICIAR ---- */
        var btnReiniciar = document.createElement("button")
        btnReiniciar.setAttribute("class", "reload")
        btnReiniciar.setAttribute('value', maquina.Id)
        btnReiniciar.addEventListener("click", function () {
            var valorClicado = btnReiniciar.value
            var botaoConfirmacao = document.getElementById("confirm_reiniciar");
            botaoConfirmacao.value = valorClicado
            abrirModalReiniciar()
        })
        btnReiniciar.innerHTML = "Reiniciar"
        /* -------------------------- */

        var divTimeReload = document.createElement("div")
        divTimeReload.setAttribute("class", "time-reloader")

        var spanTimeReload = document.createElement("span")
        var bTimeReload = document.createElement("p")
        bTimeReload.innerHTML = `Ligada há <b>${maquina.tempo_formatado}</b>`
        spanTimeReload.appendChild(bTimeReload)

        divTimeReload.appendChild(spanTimeReload)

        divStatusMaquina.appendChild(imgStatusMaquina)
        divConexaoMaquina.appendChild(divStatusMaquina)
        divConexaoMaquina.appendChild(spanStatus)

        divSeiLa.appendChild(divConexaoMaquina)
        divSeiLa.appendChild(divNomeMaquina)

        divInfoTime.appendChild(divSeiLa)
        divInfoTime.appendChild(btnReiniciar)
        divInfoTime.appendChild(divTimeReload)

        liMaquina.appendChild(divInfoTime)

        ul_lista_maquinas.appendChild(liMaquina)
    }


    // Função pra plotar os dados no gráfico
    google.charts.load("current", { packages: ['corechart'] });
    // google.charts.setOnLoadCallback(drawChart(dados));
    function drawChart(dados) {
        /* debugger */
        // console.log(dados)
        var contQtdColunas = 0;
        var vetorInteiro = [['Nome máquina']]
        var ultimaHora = ''

        for (let i = 0; i < dados.length; i++) {
            if (vetorInteiro[0].indexOf(dados[i].nomeMaquina) == -1) {
                vetorInteiro[0].push(dados[i].nomeMaquina);
            }
        }

        // cria um vetor que vai conter os dados de ramUso para cada horário (ex: ['08:00', 32.6, 31.3, 22.7])
        var vetorDaHora = []
        // loop nos dados de uso de RAM de cada máquina
        for (let i = 0; i < dados.length; i++) {
            // se o vetor estiver vazio, insira o horário da captura (irá inserir apenas uma vez) e o uso de RAM desta captura
            if (vetorDaHora.length == 0) {
                vetorDaHora.push(dados[i].dataHora1);
                vetorDaHora.push(dados[i].ramUso);
            }
            // caso o vetor não esteja vazio (ou seja, ele terá no mínimo dois valores como por ex ['08:00', 32.6])
            else {
                // inserir os outros valores daquela hora
                // precisa verificar se a hora do registro da iteração atual (dados[i].dataHora1) existe dentro do vetorDaHora
                // pra saber se esse registro pertence a aquele horário
                if (vetorDaHora.indexOf(dados[i].dataHora1) != -1) {
                    vetorDaHora.push(dados[i].ramUso);
                } else {
                    // se o valor desse registro não pertencer ao horário já inserido no vetorDaHora
                    // inserir no vetor inteiro os valores deste horário
                    // console.log("Inserindo no vetor inteiro o vetor: " + vetorDaHora);
                    vetorInteiro.push(vetorDaHora)
                    // limpar o vetorDaHora para começar a inserção de valores para um novo horário
                    vetorDaHora = []
                    // inserir o horário no vetor
                    vetorDaHora.push(dados[i].dataHora1)
                    // inserir o primeiro valor no vetor daquele horário
                    vetorDaHora.push(dados[i].ramUso)
                }
            }
        }
        // console.log(vetorInteiro);

        // var data = google.visualization.arrayToDataTable([['Nome máquina', 'máquina01', 'máquina02', 'máquina03'],
        // ['08:00', 32.6, 31.3, 22.7],
        // ['09:00', 12.2, 22.8, 24],
        // ['10:00', 38.1, 29.1, 35],
        // ['11:00', 41.9, 30.3, 54],
        // ['12:00', 48.6, 32.3, 54],
        // ['13:00', 56, 22, 14],
        // ['14:00', 24, 43, 24],
        // ['15:00', 12.3, 43, 22],
        // ['16:00', 29, 43, 24.4],
        // ['17:00', 19, 43, 35],
        // ['18:00', 49.2, 53, 46],
        // ['19:00', 33, 43, 28.7],
        // ['20:00', 15, 23, 14]
        // ]);
        var data = google.visualization.arrayToDataTable(vetorInteiro);

        var options = {
            height: 250,
            legend: { position: 'top', maxLines: 6 },
            bar: { groupWidth: '75%' },
            isStacked: true,
            tooltip: {
                isHtml: true,
                formatter: function (tooltipItem, data) {
                    var rowIndex = tooltipItem.row;
                    var columnIndex = tooltipItem.column;
                    var value = data.getValue(rowIndex, columnIndex);
                    var machineName = data.getColumnLabel(columnIndex);
                    var time = data.getValue(rowIndex, 0);
                    var formattedValue = value.toLocaleString() + 'GB';
                    return '<div><strong>' + machineName + '</strong><br>' + time + ': ' + formattedValue + '</div>';
                }
            }
        };

        var chart = new google.visualization.ColumnChart(document.getElementById("div_grafico"));
        chart.draw(data, options);
    }

    function vincularDiretor() {
        var uuid = codigo_diretor.value
        var idEmpresa = sessionStorage.ID_EMPRESA
        var idUsuario = sessionStorage.ID_USUARIO

        if (uuid.length != 36) {
            // console.log(uuid.length)
            codigo_diretor.style = 'background-color: #ff7474;'
            codigo_diretor.value = ''
            codigo_diretor.placeholder = `--CÓDIGO INVÁLIDO--`
        } else if (idEmpresa == null || idEmpresa == undefined) {
            alert("Empresa não listada")
        } else if (idUsuario == null || idUsuario == undefined) {
            alert("Usuário não listado")
        } else {

            fetch(`/datawatch/vincularDiretor/${idUsuario}`, {
                method: "post",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    idEmpresa: idEmpresa,
                    uuid: uuid
                })
            }).then(function (resposta) {
                // console.log("resposta: ", resposta);
                if (resposta.ok) {
                    codigo_diretor.value = ''
                    codigo_diretor.placeholder = `DIRETOR ADICIONADO`;
                    codigo_diretor.style = 'background-color: #d0ffbb;';
                    vincular_diretor.style = 'background-color: #6cbb41;';
                    vincular_diretor.innerHTML = `<b>Vinculado</b>`;
                    setTimeout(restaurarEstiloOriginal, 5000);
                    // hideModalWithSaveEditar()
                    // limparCampos(inputs)
                }
                // } else if (resposta.status == 404) {
                //     window.alert("Deu 404!");
                // } else {
                //     throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
                // }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
            return false
        }
    }

    /* RESTAURAR CAMPO COPIAR E COLAR DIRETOR */
    function restaurarEstiloOriginal() {
        codigo_diretor.placeholder = ``;
        codigo_diretor.style = 'background-color: #F2CB05;';
        vincular_diretor.innerHTML = `<b>Vincular</b>`;
        vincular_diretor.style = 'background-color: #FFFFFF;';
    }


</script>