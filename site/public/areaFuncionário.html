<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>DATAWATCH | Administração</title>

    <script src="./js/funcoes.js"></script>

    <link rel="icon" href="./assets/imgs/LOGOV2.png">
    <link rel="stylesheet" href="./css/areaFuncionario.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

</head>

<body onload="getId()">
    <!-- NAVBAR -->
    <header>
        <nav class="nav-bar">
            <div class="hamburger-menu">
                <input id="menu__toggle" type="checkbox" />
                <label class="menu__btn" for="menu__toggle">
                    <span></span>
                </label>



                <ul class="menu__box">
                    <div class="image">
                        <img src="../public/assets/imgs/imagem-do-usuario-com-fundo-preto.png" alt=""
                            style="height: 200px; width: 200px; border-radius: 50%; ">
                    </div>
                    <div class="nomeUser">
                        <span>Nome funcionario</span>
                    </div>
                    <li><a class="menu__item" href="../public/areaFuncionário.html">Home</a></li>
                    <li><a class="menu__item" onclick="limparSessao()">Logout</a></li>
                </ul>
            </div>



            <div class="logo">
                <a href="./areaFuncionário.html">
                    <img src="assets/imgs/LOGOcomTextoV2.png" alt="" width="150px">
                </a>
            </div>
        </nav>

    </header>

    <section>
        <div class="usuario">
            <span id="span_usuario"></span>
        </div>
        <div class="container">
            <div class="placa">
                <div class="legenda">
                    <span class="legendaTexto">
                        <div class="corLegenda"></div>
                        <p>estável</p>
                    </span>
                    <span class="legendaTexto">
                        <div class="corLegenda2"></div>
                        <p>atenção</p>
                    </span>
                    <span class="legendaTexto">
                        <div class="corLegenda3"></div>
                        <p>urgente</p>
                    </span>
                </div>


                <ul class="cards" id="ul_cards_maquinas">
                    <button id="popup_botao">OI</button>
                    <!--  <li class="card">
                    <div>
                        <h3 class="card-title">Maquina 1</h3>

                    </div>
                    <div class="card-link-wrapper">
                        <div class="status2"></div><span><b>Inativo</b></span>
                    </div>
                </li>
                <li class="card">
                    <div>
                        <h3 class="card-title">Maquina 2</h3>
                        <div class="card-content">

                        </div>
                    </div>
                    <div class="card-link-wrapper">
                        <div class="status"></div><span><b>Ativo</b></span>
                    </div>
                </li>
                <li class="card">
                    <div>
                        <h3 class="card-title">Maquina 3</h3>
                        <div class="card-content">

                        </div>
                    </div>
                    <div class="card-link-wrapper">
                        <div class="status2"></div><span><b>Inativo</b></span>
                    </div>
                </li>
                <li class="card">
                    <div>
                        <h3 class="card-title">Maquina 4</h3>
                        <div class="card-content">

                        </div>
                    </div>
                    <div class="card-link-wrapper">
                        <div class="status"></div><span><b>Ativo</b></span>
                    </div>
                </li>
                <li class="card">
                    <div>
                        <h3 class="card-title">Maquina 4</h3>
                        <div class="card-content">

                        </div>
                    </div>
                    <div class="card-link-wrapper">
                        <div class="status"></div><span><b>Ativo</b></span>
                    </div>
                </li> -->
                </ul>

            </div>
        </div>
    </section>
    <!-- <div id="div_container_modal" class="container-modal" style="display: none;">
        <div class="modal-inteiro">
            <ul class="menus-geral">
                <li class="menu1" onclick="showGraphs()">
                    <span>Gráfico</span>
                </li>
                <li class="menu1" onclick="showAlerts()">
                    <span>Alertas</span>
                </li>
                <li class="menu1" onclick="showInfos()">
                    <span>Informações Máquina</span>
                </li>
            </ul>
            <ul class="menus-graficos">
                <li class="menu2" onclick="drawChartCpu()">
                    <span>CPU</span>
                </li>
                <li class="menu2" onclick="drawChartRam()">
                    <span>RAM</span>
                </li>
                <li class="menu2" onclick="drawChartDisco()">
                    <span>DISCO</span>
                </li>
                <li class="menu2" onclick="drawChartRede()">
                    <span>REDE</span>
                </li>
            </ul>
            <div class="modal-conteudo">
                <div id="div_grafico_modal" class="grafico-conteudo" style="border: solid 2px black; height: 600px;">

                </div>
            </div>
        </div>
    </div> -->

    <div id="popup_fundo" class="popup">
        <div class="popup_conteudo">
            <div class="telaCadastro">
                <div class="modal-inteiro">
                    <ul class="menus-geral">
                        <li class="menu1" onclick="abaGrafico()">
                            <span>Gráfico</span>
                        </li>
                        <li class="menu1" onclick="abaAlerta()">
                            <span>Alertas</span>
                        </li>
                        <li class="menu1" onclick="abaInfo()">
                            <span>Informações Máquina</span>
                        </li>
                    </ul>
                    <div class="conter" id="contendo">
                        <ul class="menus-graficos">
                            <li class="menu2" onclick="drawChartCpu()">
                                <span>CPU</span>
                            </li>
                            <li class="menu2" onclick="drawChartRam()">
                                <span>RAM</span>
                            </li>
                            <li class="menu2" onclick="drawChartDisco()">
                                <span>DISCO</span>
                            </li>
                            <li class="menu2" onclick="drawChartRede()">
                                <span>REDE</span>
                            </li>
                        </ul>
                    </div>
                    <div class="modal-conteudo" id="conteudo">
                        <div id="div_grafico_modal" class="grafico-conteudo"
                            style="height: 400px; margin-bottom: 40px;"></div>
                    </div>

                    <div class="alerta" id="alert" style="display: none;">
                        <div class="modal-alerta">
                            <div class="descricaoAlerta">
                                <div class="imagemMaquina">
                                    <img src="./assets/icon/alerta.png" alt="" style="width: 150px;">
                                </div>
                                <div class="informacoes">
                                    <div class="info">
                                        <span><b>Id do alerta:</b> 1</span>
                                        <span><b>Data do alerta:</b> 22/06/2020</span>
                                        <span><b>Hora do alerta:</b> 23:30</span>
                                    </div>
                                    <div class="texto">
                                        <span><b>Descrição do alerta</b></span>
                                        <div class="scroll-desc">
                                            <span>sabfaisfhsaufhasufaoiufhasufa.sw duhasudihqdhwiqduqwaduw
                                                duqw8udwqduqwdhuiwqh diuqwhduiqwhy asuahdiahas scbdasibciashdiasudxh
                                                saudhiuashiduashidxua</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="listaAlerta">
                                <div class="listaTitulo">
                                    <span>Registro de alertas (30 dias)</span>
                                </div>
                                <ul>
                                    <div class="lista-registro">
                                        <li>
                                            <div class="rowInfo">
                                                <span>Id: 1 </span>
                                                <span>Titulo: dosahfouashfoSHODSh</span>
                                            </div>
                                        </li>
                                    </div>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="info-maquina" id="maquina-info" style="display: none;">
                        <div class="modal-info">
                            <div class="titulo-info">
                                <span>Especificações técnicas da máquina</span>
                            </div>
                            <div class="dados-maquina">
                                <span><b>Nome da máquina:</b> maquina02</span>
                                <span><b>Sistema Operacional:</b> Windows</span>
                                <span><b>Permissões:</b> Sei la</span>
                                <span><b>Tempo de atividade:</b> 2d 5h 26min</span>
                            </div>
                        </div>
                        <div class="conteudo">
                            <button class="reload">Reiniciar</button>
                        </div>
                    </div>
                    <div class="modal-parent5" style="display: none;">
                        <div class="modal-reiniciar">
                            <div class="reiniciar">
                                <div class="texto-reiniciar">
                                    <span><b>Você deseja realmente reiniciar essa maquina?</b></span>
                                </div>
                                <div class="opcao2">
                                    <button class="btnS" id="confirm_reiniciar"><b>Sim</b></button>
                                    <button class="btnN" id="cancel_reiniciar"><b>Não</b></button>
                                </div>
                            </div>
                            <span class="X-5">&times;</span>
                        </div>
                    </div>
                </div>
                <!-- <div class="formularioCadastro">
                    <div class="conteudoCadastro">
                        <h1>Cadastre sua Conta</h1>
                        <div id="alerta_erro"></div>
                        <div class="inputCadastro">
                            <input type="text" id="inp_nome" placeholder="Nome" onchange="sem_borda(1)">
                            <input type="text" id="inp_sobrenome" placeholder="Sobrenome" onchange="sem_borda(2)">
                            <input type="text" id="inp_email" placeholder="E-mail" onchange="sem_borda(3)">
                            <input type="password" id="inp_senha" placeholder="Senha" onchange="sem_borda(4)">
                            <input type="password" id="inp_confirmacao" placeholder="Confirmação de Senha"
                                onchange="sem_borda(5)">
                        </div>
                        <button class="botaoCadastrar" onclick="cadastrar()">Cadastrar</button>
                        <p>Já tem uma conta? <b><a onclick="abrirLogin()"><u>Clique
                                        aqui</u></a></b> para Entrar</p>
                    </div>
                </div>
                <div class="imgCadastro">
                </div> -->
                <!-- <span class="popup_fechar">&times;</span> -->
            </div>
        </div>
    </div>

</body>
<script>

    // popup
    var popup = document.getElementById('popup_fundo');
    // abrir o popup
    var botao = document.getElementById('popup_botao');
    // botao fechar
    // var popup_fechar = document.getElementsByClassName('popup_fechar')[0];

    const modalGrafico = document.getElementById('conteudo');
    const modalAlerta = document.getElementById('alert');
    const graficoMenu2 = document.getElementById('contendo');
    const modalInfo = document.getElementById('maquina-info');

    // abrir com clique
    botao.addEventListener('click', abrirPopup);

    // fechar com clique no botao
    // popup_fechar.addEventListener('click', fecharPopup);

    // fechar com clique fora do popup
    window.addEventListener('click', fecharFora);

    // função para abrir com o clique
    function abrirPopup(idMaquina) {
        popup.style.display = 'block';
        obterdados(idMaquina)
    }

    // função para fechar popup com o clique no botão
    // function fecharPopup() {
    //     popup.style.display = 'none';
    // }

    // função para fechar popup se clicar fora
    function fecharFora(e) {
        if (e.target == popup) {
            popup.style.display = 'none';
            modalGrafico.style.display = 'block'
            modalAlerta.style.display = 'none'
            graficoMenu2.style.display = 'block'
            modalInfo.style.display = 'none'
        }
    }

    function abaGrafico() {
        modalGrafico.style.display = 'block'
        modalAlerta.style.display = 'none'
        graficoMenu2.style.display = 'block'
        modalInfo.style.display = 'none'


        drawChartCpu()
        drawChartDisco()
        drawChartRam()
        drawChartRede()
    }

    function abaAlerta() {
        modalGrafico.style.display = "none"
        modalAlerta.style.display = 'block'
        graficoMenu2.style.display = 'none'
        modalInfo.style.display = 'none'

    }

    function abaInfo() {
        modalGrafico.style.display = "none"
        modalAlerta.style.display = 'none'
        graficoMenu2.style.display = 'none'
        modalInfo.style.display = 'block'
    }


    function getId() {
        var idEmpresa = sessionStorage.ID_EMPRESA;
        var usuario = sessionStorage.NOME_USUARIO;
        if (usuario == '') {
            span_usuario.innerHTML = `Olá, visitante!`

        } else {
            span_usuario.innerHTML = `Olá, ${usuario}!`
        }
        mostrarMaquinasFuncionarios(idEmpresa)
    }

    function mostrarMaquinasFuncionarios(idEmpresa) {
        fetch("/datawatch/pegarMaquinas", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idEmpresaServer: idEmpresa
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                resposta.json().then(dados => {
                    console.log(dados)
                    if (dados.length > 0) {
                        dados.forEach(maquina => {
                            var lista_maquinas = document.getElementById("ul_cards_maquinas");

                            var li = document.createElement("div")
                            li.setAttribute("class", "card")

                            var divTitle = document.createElement("div")

                            var pTitle = document.createElement("p")
                            pTitle.innerHTML = maquina.nomeMaquina

                            divTitle.appendChild(pTitle)
                            li.appendChild(divTitle)

                            var icon = document.createElement("div")
                            icon.setAttribute("id", "icon")
                            icon.setAttribute("class", "icon")


                            var iconAlert = document.createElement("div")
                            var textAlert = document.createElement("div")
                            var pTextAlert = document.createElement("p")
                            pTextAlert.innerHTML = maquina.contagemChamados;

                            iconAlert.setAttribute("id", "alerta")
                            textAlert.setAttribute("id", "textAlerta")
                            pTextAlert.setAttribute("id", "pTextAlert")

                            iconAlert.setAttribute("class", "iconAlert")
                            textAlert.setAttribute("class", "textAlert")
                            pTextAlert.setAttribute("class", "pTextAlert")

                            var divContent = document.createElement("div")
                            divContent.setAttribute("class", "content")

                            var divStatus = document.createElement("div")
                            var spanStatus = document.createElement("span")
                            if (maquina.statusSistema == 1) {
                                divStatus.setAttribute("class", "status")
                                spanStatus.innerHTML = " ONLINE"
                            } else {
                                divStatus.setAttribute("class", "status2")
                                spanStatus.innerHTML = " OFFLINE"
                            }

                            textAlert.appendChild(pTextAlert)
                            iconAlert.appendChild(textAlert)
                            divContent.appendChild(divStatus)
                            divContent.appendChild(spanStatus)

                            li.appendChild(icon)
                            li.appendChild(iconAlert)

                            li.appendChild(divContent)

                            li.style = "background-color: rgb(255, 179, 179)"

                            if (maquina.contagemChamados == 0) {
                                li.style = "background-color: rgb(189, 255, 188)"
                            } else if (maquina.contagemChamados >= 1 && maquina.contagemChamados <= 3) {
                                li.style = "background-color: rgb(255, 254, 167)"
                            } else {
                                li.style = "background-color: rgb(255, 179, 179)"
                            }
                            li.setAttribute('value', maquina.Id)
                            li.addEventListener('click', function () {
                                abrirPopup(li.getAttribute('value'))
                            })
                            lista_maquinas.appendChild(li)
                            console.log(lista_maquinas)
                        });
                    }

                })
            }
            else {
                throw (JSON.stringify(resposta))
            }
        }).catch(function (resposta) {
            console.log(`ERRO: ${resposta}`);
        })
        return false
    }

    var vetorHora = [];
    var vetorRedeUpload = [];
    var vetorRedeDownload = [];

    //PROCESSADOR
    var vetorPorcentagemCpu = [];
    var vetorHorasPorcentagem = [];

    //TEMPERATURA
    var temperatura = [];

    // DISCO
    var capacidadeDiscoTotal = 0;
    var capacidadeDiscoLivre = 0;

    // RAM 
    var CapacidadeRamTotal = 0;
    var CapacidadeRamEmUso = 0;


    // MÉTRICA
    var metrica = {
        Processador: "",
        Ram: "",
        Disco: ""
    }

    function obterdados(idMaquina) {
        // div_container_modal.style = "display: block;"
        fetch(`/dados/tempo-real/${idMaquina}`)
            .then(resposta => {

                if (resposta.ok) {
                    resposta.json().then(resposta => {

                        // console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                        vetorHora = [];
                        vetorRedeUpload = [];
                        vetorRedeDownload = [];

                        //PROCESSADOR
                        vetorPorcentagemCpu = [];
                        vetorHorasPorcentagem = [];

                        //TEMPERATURA
                        temperatura = [];

                        // DISCO
                        capacidadeDiscoTotal = 0;
                        capacidadeDiscoLivre = 0;

                        // RAM 
                        CapacidadeRamTotal = 0;
                        CapacidadeRamEmUso = 0;


                        // MÉTRICA
                        metrica = {
                            Processador: "",
                            Ram: "",
                            Disco: ""
                        }

                        for (i = 0; i < resposta.length; i++) {
                            var registro = resposta[i];

                            // HORÁRIO (Para parametros)
                            vetorHora.push(registro.horario);

                            // REDE (Banco)
                            vetorRedeDownload.push(registro.download);
                            vetorRedeUpload.push(registro.upload);

                            // CPU (Banco)
                            vetorPorcentagemCpu.push(registro.cpuuso);

                            // TEMPERATURA (Banco)
                            temperatura.push(registro.temperatura);

                            // DISCO (Banco)
                            capacidadeDiscoLivre = registro.discolivre;
                            capacidadeDiscoTotal = registro.discoTotal;

                            // RAM (Banco)
                            CapacidadeRamTotal = registro.ramTotal;
                            CapacidadeRamEmUso = registro.ramUso;


                            // MÉTRICA (Banco)
                            metrica.Processador = registro.processadorMetrica;
                            metrica.Ram = registro.ramMetrica;
                            metrica.Disco = registro.discoMetrica;

                            drawChartCpu()

                        }
                    });
                } else {

                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados do aquario p/ gráfico: ${error.message}`);
            });
    }

    // Gráfico RAM
    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(drawChartRam);


    function drawChartRam() {

        var data = google.visualization.arrayToDataTable([
            ['', ''],
            ['Em uso', CapacidadeRamEmUso],
            ['Total', CapacidadeRamTotal]
        ]);

        var options = {
            title: 'Uso de RAM:'
        };

        var chart = new google.visualization.PieChart(document.getElementById('div_grafico_modal'));
        //     fraseMetrica.innerHTML = `Dados RAM 
        // <br>Em uso: 
        // <br>Disponível:`;
        chart.draw(data, options);
    }


    // Gráfico CPU
    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(drawChartCpu);

    function drawChartCpu() {
        var data = google.visualization.arrayToDataTable([
            ['Horário', 'Porcentagem %', 'Sales'],
            [vetorHora[0], vetorPorcentagemCpu[0]],
            [vetorHora[1], vetorPorcentagemCpu[1]],
            [vetorHora[2], vetorPorcentagemCpu[2]],
            [vetorHora[3], vetorPorcentagemCpu[3]],
            [vetorHora[4], vetorPorcentagemCpu[4]],
            [vetorHora[5], vetorPorcentagemCpu[5]],
            [vetorHora[6], vetorPorcentagemCpu[6]],
            [vetorHora[7], vetorPorcentagemCpu[7]],
            [vetorHora[8], vetorPorcentagemCpu[8]],
            [vetorHora[9], vetorPorcentagemCpu[9]],
        ]);

        // console.log(vetorHora, vetorHorasPorcentagem, vetorPorcentagemCpu)

        var options = {
            title: 'Company Performance',
            curveType: 'function',
            legend: { position: 'bottom' }
        };


        var chart = new google.visualization.LineChart(document.getElementById('div_grafico_modal'));
        // confidencial = document.getElementById("processadorTitulo");
        //     fraseMetrica.innerHTML = `Dados Processador 
        // <br>Utilização: `;

        chart.draw(data, options);
    }

    // Gráfico Disco
    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(drawChartDisco);

    function drawChartDisco() {

        var data = google.visualization.arrayToDataTable([
            ['Disco', 'Memória'],
            ['Capacidade em uso', capacidadeDiscoTotal],
            ['Capacidade livre', capacidadeDiscoLivre],

        ]);

        var options = {
            title: 'Disco:'
        };

        var chart = new google.visualization.PieChart(document.getElementById('div_grafico_modal'));
        //     fraseMetrica.innerHTML = `Dados Disco 
        // <br> Capacidade Total: ${capacidadeDiscoTotal}
        // <br> Capacidade em uso: ${capacidadeDiscoLivre}`;
        chart.draw(data, options);
    }

    // Gráfico Rede
    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(drawChartRede);


    function drawChartRede() {
        var data = google.visualization.arrayToDataTable([
            ['horário', 'Upload', 'Download'],
            [vetorHora[0], vetorRedeUpload[0], vetorRedeDownload[0]],
            [vetorHora[1], vetorRedeUpload[1], vetorRedeDownload[1]],
            [vetorHora[2], vetorRedeUpload[2], vetorRedeDownload[2]],
            [vetorHora[3], vetorRedeUpload[3], vetorRedeDownload[3]],
            [vetorHora[4], vetorRedeUpload[4], vetorRedeDownload[4]],
            [vetorHora[5], vetorRedeUpload[5], vetorRedeDownload[5]],
            [vetorHora[6], vetorRedeUpload[6], vetorRedeDownload[6]],
            [vetorHora[7], vetorRedeUpload[7], vetorRedeDownload[7]],
            [vetorHora[8], vetorRedeUpload[8], vetorRedeDownload[8]],
            [vetorHora[9], vetorRedeUpload[9], vetorRedeDownload[9]],

        ]);

        var options = {
            title: 'Internet em kbps',
            curveType: 'function',
            legend: { position: 'bottom' }
        };

        var chart = new google.visualization.LineChart(document.getElementById('div_grafico_modal'));
        // confidencial = document.getElementById("redeTitulo");
        // fraseMetrica.innerHTML = `Dados Rede 
        // <br>Enviar: 
        // <br>Receber: `;

        chart.draw(data, options);
    }

</script>